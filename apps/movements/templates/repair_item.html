{% extends "base.html" %}
{% load i18n %}
{% load styling %}
{% load generic_views_helpers %}
{% block title %}{%trans "Repair Asset" %}{% endblock %}

{% block javascript %}
<script type="text/javascript">
    var date_fmt1 = /([0-3]?[0-9])\/([0-1]?[0-9])\/([0-9]{4})/; // European DD/MM/YYYY
    var date_fmt2 = /([0-9]{4})-([0-1]?[0-9])-([0-3]?[0-9])/; // ISO YYYY-MM-DD
</script>
<script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/repair_item.js" ></script>
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block stylesheets %}
    {{ wizard.form.media }}
    <link href="{{ STATIC_URL }}css/repair_item.css" type="text/css" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="content" width="90%"  >
<form action="." method="post" onsubmit="return validateForm(this)" >{% csrf_token %}
<h2>{% trans 'Repair form:' %} {{ item }}</h2>
<table id="repair_fields" width="100%">
<tr><td width="*">
    <table id="rform">
        <tr><td>{% trans 'Now at:' %}</td> <td>{{ item.location }}</td> </tr>
        <tr><td><label for="issue_date" class="required">{% trans 'Issue date:' %}</label></td>
            <td><input name="issue_date" id="id_issue_date" type="text"/>
                <div id="date_invalid" style="display: none; color: red;">
                    {% trans 'You have to enter a date in DD/MM/YYY format' %}
                </div>
            </td>
        </tr>
        <tr><td><label for="user_id">{% trans 'User ID:' %}</label></td>
            <td><input name="user_id" type="text"/></td>
        </tr>
    </table>
  </td>
  <td width="*">
    <label for="notes">{% trans 'Notes' %}</label><br/>
    <textarea name="notes" style="min-height: 5em; min-width: 70%"></textarea>
  </td>
</tr>
</table>

<table id="three_columns" width="100%">
<tr><th width="33%">{% trans 'Spare parts' %}</th>
    <th width="33%">{% trans 'In Asset' %}</th>
    <th width="33%">{% trans 'Removed parts' %}</th></tr>
<tr>
    <td><div class="hint">{% blocktrans %}Spare parts are those that are currently in some other location, but could added into this bundle.<br/>
    You can drag them into the lower box of the asset.
    {% endblocktrans %}
        </div>
        <div id="sources">
            {% for src, allitems in src_locations %}
                {% if allitems %}
                <h3>{{ src }}</h3>
                <div class="source">
                {% regroup allitems by item_template.category as ilist %}
                {% for items in ilist %}
                <h4>{{ items.grouper }}</h4>
                <ul>
                    {% for si in items.list %}
                        <li id="item-{{si.id}}" title="{%trans 'You can drag this part to the middle column' %}">{{si }}</li>
                    {% endfor %}
                </ul>
                {% endfor %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </td>
    <td>
        <h3>{% trans 'Contains' %}</h3>
        <div id="parts_in_item">
            <ul>
            {% for part in item.itemgroup.items.all %}
                <li id="item-{{part.id}}" title="{%trans 'This part can be dragged to the right column'%}">{{ part }}</li>
            {% endfor %}
            </ul>
        </div>
        <h3>{% trans 'Add in repair' %}</h3>
        <div id="item_target" class="target">
            <ul>
                <li class="hint">{% trans 'Drag here the parts you want to add to the item.' %}</li>
            </ul>
        </div>
    </td>
    <td>
        <div id="dests">
            {% for trg in dest_locations %}
                <h3>{{ trg }}</h3>
                <div>
                    <div class="target">
                        <ul id="outbin-{{ trg.id }}" >
                            <li class="hint">{% trans 'Drag here the parts you want to remove.' %}</li>
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="hint">{% blocktrans %}These are the locations where current components of the bundle can be moved into.
    Please open the corresponding location and drag items into it.<br/>
    You can only select items from the top-middle column, items that had been in the bundle.
        {% endblocktrans %}
    </div>
    </td>
</tr>
</table>

<h3>{% trans "Description of movements" %}</h3>
<div id="story">
    <p id="story_noitems">{% trans "No parts have changed yet" %}</p>
    <div style="display: none" id="story_added">
        <h4>{% trans 'These parts will be added to the bundle' %}</h4>
        <ul> </ul>
    </div>
    <div style="display: none" id="story_removed">
        <h4>{% trans 'These parts will be removed from the bundle' %}</h4>
        {% for trg in dest_locations %}
                <h5 id="outstory-h-{{trg.id}}">{% trans 'To:' %} {{ trg }}</h5>
                <ul id="outstory-{{ trg.id }}" style="display: none;"> </ul>
        {% endfor %}
    </div>
</div>

<div id="dsubmit" style="display: none" class="submit_button">
    <p>
    {%blocktrans %}If you agree with the above movements, you can now press the submit
    button and the appropriate actions will be prepared for the repair. <br/>
    After those, the repair form will still need to be validated by an authorized user.
    {% endblocktrans %}
    </p>
    <p style="text-align: left; width: 100%">
        <button type="submit">{% trans 'Submit' %}</button>
    </p>
</div>
</form>

<script src="{{ STATIC_URL }}js/jquery.ui.datepicker-{{ LANGUAGE_CODE }}.js"></script>
    <script>
        $(function(){
            $("#id_issue_date").datepicker({dateFormat: 'dd/mm/yy', changeYear: false, yearRange: '-15:+2'})
        });
    </script>
</div>

{% endblock %}
