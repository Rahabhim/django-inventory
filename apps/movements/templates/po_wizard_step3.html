{% extends "po_wizard_base.html" %}
{% load i18n %}
{% load styling %}
{% load generic_views_helpers %}

{% block javascript %}
<script type="text/javascript">
    if (!window.console)  console = {log: function() {}};
    $(function() {
        $( "#step3_tabs" ).tabs();
    });

</script>
<script type="text/javascript" src="{{ STATIC_URL }}/js/ui-combobox.js"></script>
{% endblock %}

{% block pow_content %}
<div class="u2_form">
<style>
    #ss3s-1 > div {
    background: none repeat scroll 0 0 #F8F8F8;
    border: 2px solid #a7a7a7;
    margin-left: 36px;
    padding: 10px;
    }

    #label_not_found {
        display: none;
        background-color: #FFDCA8;
        padding: 4px;
        padding-right: 4em;
    }
    #label_not_found img {
        margin-right: 10px;
    }
    #ss3s-1 div.found_product {
        background: #C8FFFF;
        border: 2px solid #a7a7a7;
    }

    div.found_product #{{wizard.form.item_template.auto_id}}_text {
        display: none;
    }
    div.found_product #{{wizard.form.item_template.auto_id}}_on_deck div {
        background-color: #C0FFFF;
    }

    #qty_container {
        display: auto;
    }
    #ss3s-1 > div hr {
        margin-top: 1.2em;
    }

    .product_search label {
        display: inline-block;
        width: 15em;
    }
    #note_not_found {
        margin-left: 2em;
    }
    #note_not_found button {
        border:0px solid #fff;  /* needed for opera */
        border-bottom:1px solid blue;
        background:transparent;
        color:blue;
        cursor:pointer;
        display: inline;
    }
    #product_selection {
        padding-bottom: 4px;
    }

    #product_selection.not-found {
        background-color: #FFC0C0;
    }
    #product_selection.found.selected {
        background-color: #A7B47C;
    }
    #product_selection.found {
        background-color: #FFDCA8;
    }

</style>
<style>
  .ui-combobox {
    position: relative;
    display: inline-block;
  }
  .ui-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
  }
  .ui-combobox-input {
    margin: 0;
    padding: 3px 7px;
  }
  </style>
{{ wizard.form.management_form }}

{% with wizard.form as form %}
    <div id="ss3s-1">
        <h3>Καταχώρηση Στοιχείων  Εξοπλισμού</h3>
        <p>Μπορείτε να καταχωρήσετε τα στοιχεία του Εξοπλισμού με δύο δυνατούς τρόπους:</p>
        {{ form.line_num }}
        {{ form.in_group }}
        <div class="product_search">
            {% with form.item_template as it %}
            <label for="{{it.auto_id}}_text"> Κωδικός προϊόντος:</label>
                <input type="text" name="{{it.name}}_text" id="{{it.auto_id}}_text" value="" width="7em" />
            {% endwith %}
            <p class="hint">Αν γνωρίζετε τον κωδικό προϊόντος (πλήρες μοντέλο ή part number),
            δοκιμάστε να τον εισάγετε παραπάνω για να αναζητηθεί στη βάση μας.
            </p>
            
        </div>
        <p align="center"> ή </p>

        <div class="product_search" id="product_search_combi"> <p> Σύνθετη αναζήτηση με βάση τα παρακάτω στοιχεία:
                </p>
            
        <label>Κατασκευαστής: </label>{{ form.manufacturer }}<br/>
        {# form.product_attributes #}
            <div id="{{form.product_attributes.auto_id}}">
                {% for attrib in  form.product_attributes %}
                    <div class="product_attrib">{{ attrib|safe }}</div>
                {% endfor %}
            </div>
            <hr/>
            <div id="product_selection">
                <label>{{form.item_template2.label}}:<span id="product_combo_results"></span></label>
                    {{ form.item_template2 }}
            </div>
        </div>
        <div class="found_product">
           <label>Επιλεγμένο προϊόν:</label> {{ form.item_template }}
            <span id="qty_container">&times;
                {% if form.category_is_group %}
                    1
                    <input type="hidden" name="3-{{form.quantity.name}}" id="{{form.quantity.auto_id}}" value="1">
                {% else %}
                    {{ form.quantity }}
                {% endif %}
                ({{ form.quantity.label }})</span>
        </div>
        <div id="label_not_found"><img src="{{ STATIC_URL }}images/dialog-warning.png" width="22px" height="22px"/>Δεν επιλέχθηκε προϊόν </div>
        <div id="note_not_found">
            <i>Σημείωση</i>: Σε περίπτωση που δεν βρήκατε τον εξοπλισμό που επιθυμείτε
            επιλέξτε εδώ για
            <a href="{% url template_request2 %}" target="_blank">αίτημα καταχώρησης νέου προϊόντος</a>
        </div>
    </div>

    <div id="ss3s-2">
        <h3>{% trans 'Serial numbers' %}</h3>
        <div>
            {{ form.serials.label}}: <br/> {{ form.serials }}
            {% if form.serials.errors %}<div class="wf_error">
                {% for error in form.serials.errors %}<div class="error">{{ error }}</div>{%endfor %}
                </div>
            {% endif %}
        </div>
    </div>

<script>
    function update_product3(data, status, xhr){
        var pcombo = $("#{{form.item_template2.auto_id}}");
        pcombo.empty();
        pcombo.append($('<option>', {value: ''}).text('-----'));

        /* console.log("Data came! " + data.length); */
        data.sort(function(a,b) { if ( a.repr > b.repr) return 1; if (a.repr < b.repr) return -1; return 0 });
        for(i=0;i<data.length;i++){
            pcombo.append($('<option>', { value: data[i].pk }).text(data[i].repr));
        }
        if (!data.length){
            $("#note_not_found").show();
            $("#qty_container").hide();
            $("#product_combo_results").text('(δε βρέθηκε!)');
            $("#product_selection").removeClass().addClass("not-found");
        }
        else {
            $("#product_selection").removeClass().addClass("found");
            $("#product_combo_results").text('('+ data.length + ')');
        }
    }
    function update_product2(){
        var attribs = new Array();
        $("#{{form.product_attributes.auto_id}} select").each(function() { attribs.push(this.value)});
        $.ajax("{% url ajax_lookup 'product_specs' %}", {
                'dataType': 'json',
                'data': {'term': 'foo', 'attributes': attribs,
                        'category': "{{ form.category_id }}",
                        'manufacturer': $("#{{ form.manufacturer.auto_id }}")[0].value },
                'success': update_product3});

        if (attribs.length) // only if category has any attributes at all
            $.ajax("{% url product_combi_attrs %}", {
                'dataType': 'json',
                'data': { 'attributes': attribs,
                          'category': "{{ form.category_id }}",
                          'manufacturer': $("#{{ form.manufacturer.auto_id }}")[0].value
                        },
                'success': update_combos
                });
    }

    function update_combos(data) {
        $("#{{form.product_attributes.auto_id}} select").each(
            function(){
               var sel = this;
               var atype = sel.id.split('-')[2].substr(1);
               var adata = data[atype];
               if (! adata)
                    return;
                while(sel.options.length > 1)
                    sel.options.remove(1);
                sel = $(sel);
                for(var i = 0; i < adata.length; i++)
                    sel.append($("<option>").attr("value", adata[i][0]).text(adata[i][1]));
            });
    }

    $("#{{form.manufacturer.auto_id}}").combobox();
    $("#{{form.manufacturer.auto_id}}").change(update_product2);
    $("#{{form.product_attributes.auto_id}} select").change(update_product2);

    function select_some_product(){
        var $selected = $("#{{form.item_template2.auto_id}} option:selected");

        var fake_win = new Object();
        {# /* bind fake_win to item autocompletion, so that its select() is returned */ #}
        $("#{{form.item_template.auto_id}}").autocompleteselect(fake_win);
        if ($selected && $selected.val()) {
            fake_win.select(null, {item: {pk: $selected.val(), repr: $selected.text()}});
            $("#product_selection").addClass('selected');
        }
        else {
            fake_win.select(null, {item: false });
            $("#qty_container").hide();
            $("#note_not_found").show();
            $("#label_not_found").show();
            $("#product_selection").removeClass('selected');
            return false;
        }
    }
    $("#{{form.item_template2.auto_id}}").combobox();
    $("#{{form.item_template2.auto_id}}").change(select_some_product);

    $("#{{form.item_template.auto_id}}_on_deck").bind('added', function() {
        $("#label_not_found").hide();
        $("#note_not_found").hide();
        $("#qty_container").show();
        });

    $("#{{form.item_template.auto_id}}_on_deck").bind('killed', function() {
        $("#label_not_found").show();
        $("#note_not_found").show();
        $("#qty_container").hide();
        });

    /* Submit function to check validity.
        Unfortunatelly, Django does not do that for us, since we are using two
        inputs for the product.
        
        Remember NOT to bind that function to $("form").submit(...) , because
        it would also disable jumping to numbered wizard steps (ie. going back to "2").
    */
    function form3_submit(event) {
            var res = $("#{{form.item_template.auto_id}}");
            if (res.val())
                return;
            else {
                /* in case the user has selected nothing so far */
                $("#label_not_found").show();
                $("#note_not_found").show();
                event.preventDefault();
                $('html, body').animate({
                    scrollTop: $("#product_search_combi").offset().top -26 }, 1000);
                return false;
            }
        };

    $(function() {
        $("#submit0").click(form3_submit);
        /* this one (from po_wizard_base), too... */
        $("#submit_early").click(form3_submit);
        {% if not form.item_template.value %}
        $("#qty_container").hide();
        {% endif %}
    });
</script>
{% endwith %}
</div>


<div width="100%">
<p align="right">
    <input id="submit0" type="submit" value="{%trans 'Continue' %}">

</p>
</div>

{% endblock %}

