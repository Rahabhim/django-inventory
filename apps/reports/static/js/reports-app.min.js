/* reports application w. Angular
 * 
 * Copyright (C) 2014 University of Athens pchristeas@noc.uoa.gr
 */typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(e){return this.slice(0,e.length)==e});var reportsApp=angular.module("reportsApp",["ui.bootstrap","f3.movable","f3.draggable"]).config(["$interpolateProvider","$httpProvider","$locationProvider","datepickerConfig"
,"datepickerPopupConfig","appCSRFtoken",function(e,t,n,r,i,s){e.startSymbol("[["),e.endSymbol("]]"),t.defaults.headers.post["X-CSRFToken"]=s,n.html5Mode(!1),r.showWeeks=!1,i.showButtonBar=!1}]);reportsApp.controller("mainCtrl",["$log","$scope","$location","$http","$modal","$filter","$timeout","appSuperUser","appReportTypes",function(e,t,n,r,i,s,o,u,a){t.reportType=!1,t.reportGroups=[],t.available_types=
a,t.show_warning=!1,t.tabs={type:!0,params:!1,format:!1,preview:!1,results:!1},t.selectType=function(i,s){if(!i.id)return;if(t.reportType&&!s){t.show_warning=!0,o(function(){t.show_warning=!1},5e3);return}t.reportType=i,n.search("id"),t.$root.can_delete=!1,t.reportGroups=[],o(function(){t.tabs.params=!0},1200),i.fields||(e.debug("Must fetch grammar for",i.id),r.get("grammar/"+i.id).success(function(
t){e.debug("Grammar data:",t),angular.extend(i,t),i.show_detail===undefined&&(i.show_detail=!0)}))};var f=s("date2iso"),l={model:function(e){var t=[];return angular.forEach(e.fields,function(e,n){var r=l[e.widget];r===undefined&&(r=l.model);var i=r(e,n);i&&i.length&&(i[0]=="&"?angular.forEach(i[1],function(e){angular.isArray(e)&&e.length>1?t.push([n,"in",e]):t.push([n,"="].concat(e))}):i[0]=="&in"?
angular.forEach(i[1],function(e){e&&e.length&&t.push([n,"in",e])}):i[0]=="&*"?angular.forEach(i[1],function(e){e&&t.push([n,e[0],e[1]])}):t.push([n].concat(i)))}),t.length==1&&t[0][0]=="_"?["=",t[0][2]]:t.length?["in",t]:!1},"char":function(e,t){if(e.data)return[e.data_op||"icontains",e.data]},id:function(t,n){t.data&&e.warning("Filter for id:",t.data)},"boolean":function(e,t){if(e.data=="true")return["="
,!0];if(e.data=="false")return["=",!1]},date:function(e,t){if(e.data_op=="between")return[e.data_op,[f(e.data[0]),f(e.data[1])]];if(e.data_op&&e.data)return[e.data_op,f(e.data)]},lookup:function(e,t){if(e.data&&e.data_op=="in"){var n=[];return angular.forEach(e.data,function(e){e&&e.pk&&n.push(parseInt(e.pk))}),[e.data_op,n]}if(e.data)return[e.data_op||"=",parseInt(e.data.pk)]},selection:function(e
,t){if(e.data)return["=",e.data]},attribs:function(t,n){if(!t.data)return;e.debug("Atribs=> dom:",t);var r=[];angular.forEach(t.data,function(e){r.push(e)});if(r.length)return["&",r]},attribs_multi:function(e,t){if(!e.data)return;var n=[];angular.forEach(e.data,function(e){n.push(e)});if(n.length)return["&in",n]},contains:function(t,n){if(!t.contains_data)return;var r=[];return angular.forEach(t.contains_data
,function(t){var i=l[t.widget];i===undefined&&(i=l.model);var s=i(t,n);if(!s||!s.length)return;s[0]=="in"||s[0]=="="?r.push(s[1]):s[0]=="&"?angular.forEach(s[1],function(e){r.push(e)}):e.warn("Cannot use domain",s,"for",n)}),["&",r]},isset:function(e,t){if(e.data)return e.data=="0"?["=",!1]:["=",!0]},count:function(e,t){if(e.data&&e.data_op)return[e.data_op,e.data]},attribs_count:function(e,t){var n=
[];angular.forEach(e.data_op,function(t,r){e.data[r]&&n.push([r,t,e.data[r]])});if(n.length)return["in",n]},extra_attrib:function(e,t){return[]},extra_condition:function(e,t){return[]}};l["model-product"]=l.model,l.has_sth=l["boolean"],t.getCurDomain=function(){return t.reportType?l.model(t.reportType):[]},t.getFieldDomain=function(e){var t=l[e.widget];if(t)return t(e)},t.fieldByPath=function(e,n){
var r=e.split(".");r.reverse();var i=n||t.reportType;while(r.length){if(!i.fields)return;i=i.fields[r.pop()];if(!i)return}return i},t.setFieldFmt=function(e){return e.fmt?(e.fmt.title===undefined&&(e.fmt.title=e.name),!1):(e.fmt={title:e.name,sequence:e.sequence,order:!1,hide:!1},!0)};var c=function(e){var t={};return e.data_op&&(t.op=e.data_op),e.data&&(t.data=e.data),e.fmt&&(t.fmt=e.fmt),e.fields&&
(t.fields=h(e.fields)),e.contains_data&&(t.contains=[],angular.forEach(e.contains_data,function(e){t.contains.push(c(e))})),e.path&&e.path.startsWith("+")&&(t.name=e.name,t.full_name=e.full_name,t.widget=e.widget),t},h=function(e){var t={};return angular.forEach(e,function(e,n){t[n]=c(e)}),t},p=function(e,t){e.op&&(t.data_op=e.op),e.data&&(t.data=e.data),e.fmt&&(t.fmt=e.fmt),e.fields&&d(e.fields,t.
fields),e.contains&&(t.contains_data=[],angular.forEach(e.contains,function(e){var n=angular.copy(t.sub);p(e,n),t.contains_data.push(n)}))},d=function(e,t){angular.forEach(e,function(e,n){if(t[n])p(e,t[n]);else if(n.startsWith("+")){var r={name:e.name,full_name:e.full_name,path:n,full_path:n,widget:e.widget};p(e,r),t[n]=r}})};t.resetFieldData=function(e){e.data_op&&(e.data_op=undefined),e.data=undefined
,e.fields&&angular.forEach(e.fields,t.resetFieldData),e.contains&&(e.contains_data=[])};var v=function(i){e.debug("Load report:",i),r.get("back/load",{params:{id:i}}).success(function(r){e.debug("load data came:",r),t.reportType=r.grammar;var i={id:r.model,saved_id:r.id,"public":r.public,title:r.title,notes:r.notes,show_detail:r.data.show_detail,limit:r.data.limit,preview_limit:r.data.preview_limit||10
};i.show_detail===undefined&&(i.show_detail=!0),angular.extend(t.reportType,i),n.search("id",r.id),t.reportGroups=r.data.groups||[],t.fillFieldPaths(),d(r.data.fields,t.reportType.fields),t.$root.needs_save=!1,t.$root.can_save=u||!r.public,t.$root.can_delete=!0,t.tabs.type&&(t.tabs.type=!1,t.tabs.params=!0)}).error(function(t,r,i){e.debug("Load error:",t,r),n.search("id")})};t.$root.reportLoad=function(
){var t=i.open({templateUrl:"parts/file-load.html",controller:["reports","$scope",function(e,t){t.reports=e}],windowClass:"load-dlg",backdrop:"static",resolve:{reports:function(){return r.get("back/list").then(function(t){if(t.status==200)return t.data;throw e.error("list response:",t),Error(t.status)})}}});t.result.then(v)},t.$root.reportSave=function(){var n=[],s={},o=[],u=[];_calc_result_fields(
t,o,n,s,u);var a={model:t.reportType.id,title:t.reportType.title||t.reportType.name,notes:t.reportType.notes,domain:t.getCurDomain(),fields:o,show_detail:t.reportType.show_detail,group_by:t.reportGroups,limit:t.reportType.limit,field_cols:n,groupped_fields:s,order_by:u},f=i.open({templateUrl:"parts/file-save.html",controller:["$scope","report","reportGroups","$timeout",function(t,n,i,s){t.has_btn=!0
,t.message="",t.report=n,t.reportGroups=i,t.do_save=function(){var n={title:t.report.title,notes:t.report.notes,model:t.report.id,"public":t.report.public||!1,data:{groups:i,fields:h(t.report.fields),show_detail:t.report.show_detail,limit:t.report.limit,preview_limit:t.report.preview_limit},stage2:a};t.report.saved_id&&(n.id=t.report.saved_id),t.has_btn=!1,r.post("back/save",n).success(function(n){
e.debug("Saved report:",n),t.message="OK",t.report.saved_id=n.id,t.$root.can_delete=!0,s(t.$dismiss,1e3)}).error(function(n,r,i){e.debug("Error:",n,r),r==403?t.message="Permission denied":t.message="Error: "+r})}}],windowClass:"save-dlg",backdrop:"static",resolve:{report:function(){return t.reportType},reportGroups:function(){return t.reportGroups}}});f.result.then(function(){e.debug("Modal closed!"
)})},t.$root.reportSaveCopy=function(){return t.reportType.saved_id=undefined,t.reportType.title&&(t.reportType.title+=" (copy)"),t.reportSave()},t.$root.reportDelete=function(){var n=i.open({templateUrl:"parts/file-delete.html",controller:["report_id","$scope",function(e,t){t.report_id=e}],windowClass:"delete-dlg",backdrop:"static",resolve:{report_id:function(){return t.reportType.saved_id}}});n.result
.then(function(n){n&&r.post("back/delete",{id:n,confirm:!0}).success(function(){t.reportType=!1,t.reportGroups=!1,t.$root.can_delete=!1,t.$root.needs_save=!1,t.$root.can_save=!0}).error(function(t,n,r){e.debug("Error:",t,n)})})},t.$watch(function(){return n.search().id},function(e){if(!e||e===!0)return;if(e==t.reportType.saved_id)return;v(e)}),t.prepareResultsPost=angular.noop;var m=0,g=function(e,
t){e.full_path||(e.full_name=this.name_prefix+e.name,e.full_path=this.fld_prefix+t),e.fields&&angular.forEach(e.fields,g,{name_prefix:e.full_name+" / ",fld_prefix:e.full_path+"."}),e.widget=="contains"&&angular.forEach(e.sub.fields,g,{name_prefix:e.full_name+" / ",fld_prefix:e.full_path+"."})};t.fillFieldPaths=function(){if(!t.reportType)return;angular.forEach(t.reportType.fields,g,{name_prefix:"",
fld_prefix:""})},t.add_extra_field=function(e){if(m==0)for(var n in t.reportType.fields)if(n.startsWith("+")){var r=parseInt(n.split("_").pop());r>=m&&(m=r+1)}var i="+extra_"+m;m++;if(t.reportType.fields[i])throw Error("name conflict: "+i);e.path=e.full_path=i,t.reportType.fields[i]=e}}]),reportsApp.controller("reportsTypeCtrl",["$log","$scope",function(e,t){e.debug("reportsTypeCtrl:",t),t.view_short=!1
,t.type_name="?"}]),reportsApp.controller("paramsCtrl",["$log","$scope","$http","$q","appWords",function(e,t,n,r,i){t.field=!1,t.$parent.$watch("reportType",function(e){t.field=e,e&&(t.$root.needs_save=!0),e&&!e.saved_id&&(t.$root.can_save=!0)});var s={"char":function(e){if(e.data)return'"'+e.data.toString()+'"'},"boolean":function(e){if(e.data)return i[e.data]},id:function(e){},has_sth:function(e)
{if(e.data)return i["has_"+e.data]},date:function(e){if(e.data)return e.data_op=="between"?"@("+e.data[0]+", "+e.data[1]+")":e.data_op+" "+e.data},model:function(e){var n=[];angular.forEach(e.fields,function(e,r){var i=t.formatParmsData(e);i&&n.push(e.name+": "+i)});if(n.length)return"["+n.join(", ")+"]"},lookup:function(e){if(e.data&&e.data_op=="in"){var t=[];return angular.forEach(e.data,function(
e){e&&e.pk&&t.push(e.repr)}),"["+t.join(" | ")+"]"}if(e.data)return e.data.repr},selection:function(e){if(e.data)for(var t in e.selection)if(e.selection[t][0]==e.data)return e.selection[t][1]},attribs:function(e){var t=[];return angular.forEach(e.attribs,function(n){var r=e.data[n.aid];if(!r)return;for(var i=0;i<n.values.length;i++)n.values[i][0]==r&&t.push(n.name+"="+n.values[i][1])}),t.length?t.join
(","):""},attribs_multi:function(e){var t=[];return angular.forEach(e.attribs,function(n){var r=e.data[n.aid];if(!r)return;var i=[];for(var s=0;s<r.length;s++)for(var o=0;o<n.values.length;o++)n.values[o][0]==r[s]&&i.push(n.values[o][1]);i.length&&t.push(n.name+"="+i.join("/"))}),t.length?t.join(","):""},contains:function(e){var n=[];return angular.forEach(e.contains_data,function(e){var r=t.formatParmsData
(e);r&&n.push("+ "+r)}),n.length?n.join(", "):""},isset:function(e){return e.data?e.data=="0"?"empty":"set":""},count:function(e){if(e.data&&e.data_op)return""+e.data_op+e.data},attribs_count:function(e){var t=[];return angular.forEach(e.attribs,function(n){var r=e.data[n.aid],i=e.data_op[n.aid];if(!r||!i)return;t.push("SUM("+n.name+") "+i+" "+r)}),t.length?t.join(","):""},extra_attrib:function(e){
return e.fmt.title||""},extra_condition:function(e){return e.fmt.title||""}};s["model-product"]=s.model,t.formatParmsData=function(t){var n=s[t.widget];if(!!n)return n(t);e.debug("No format function for",t.widget)},t.addContains=function(e){e.contains_data||(e.contains_data=[]),e.contains_data.push(angular.copy(e.sub))},t.removeContains=function(t,n){e.debug("remove",t,"from",n);var r=n.contains_data
.indexOf(t);r>=0&&n.contains_data.splice(r,1)},t.getLookup=function(t,r){return n.get(t,{params:{term:r}}).then(function(t){return t.status==200?t.data:(e.error("lookup response:",t),[])})},t.setItemContains=function(){},t.adapt_date=function(e){e.data_op=="between"&&!angular.isArray(e.data)?e.data=[e.data,""]:e.data_op!="between"&&angular.isArray(e.data)&&(e.data=e.data[0])},t.selFieldMulti=function(
e,t,n){var r=e.data[n];for(var i=0;i<e.data.length;)e.data[i]&&e.data[i].pk?(e.data[i]===r&&(t.i=i),i++):e.data.splice(i,1)},t.addFieldMulti=function(t,n){e.debug("addFieldMulti",t);if(t.data_op!="in"&&t.data){var r=t.data;t.data=[],t.data.push(r),t.data_op="in"}else if(!t.data||n.i<t.data.length&&(!t.data[n.i]||!t.data[n.i].pk))return;t.data.push({value:"",repr:"",pk:0}),n&&(n.i=t.data.length-1)},
t.rmFieldMulti=function(e,t,n){if(e.data_op!="in")return;e.data.splice(t,1),e.data.length==0?(e.data_op="=",e.data=undefined):e.data.length==1?(e.data=e.data[0],e.data_op="="):n&&n.i>=e.data.length&&(n.i=e.data.length-1)},t.refreshCatData=function(t,i,s){if(t&&t.pk){if(i.cat_pk==t.pk)return r.reject("no change");var o=i.data;return n.get("./cat-grammar/"+t.pk).then(function(n){if(n.status==200){var r=
n.data;return i&&r.attributes&&r.attributes.length&&(i.hide=!1,i.attribs=r.attributes,i.data={},i.cat_pk=t.pk,o&&angular.forEach(r.attributes,function(e){o[e.aid]&&(i.data[e.aid]=o[e.aid])})),r}e.warn("Bad http response:",n)})}return i&&(i.hide=!0,i.data=!1,i.cat_pk=!1),r.when(!1)},t.addAsField=function(e){var n=t.getFieldDomain(e);if(!e.full_path)throw Error("no full path for field");if(n&&n!=[]){
n.unshift(e.full_path);var r={name:e.name+" ?",full_name:e.full_name,data:n,widget:"extra_condition",sequence:100};t.setFieldFmt(r);var i=t.formatParmsData(e);i&&(r.fmt.title=i),t.$parent.add_extra_field(r),t.resetFieldData(e)}},t.addAttribAsField=function(e,n){var r={name:n.name,full_name:e.full_name+"/"+n.name,data:[e.full_path,n.aid],widget:"extra_attrib",sequence:100};t.setFieldFmt(r),r.title=t
.formatParmsData(e)||e.title,t.$parent.add_extra_field(r)}}]),reportsApp.controller("productParamsCtrl",["$log","$scope",function(e,t){t.$watch("field.fields.category.data",function(e){t.refreshCatData(e,t.field.fields.attributes).then(function(e){e&&(e.is_group||e.is_bundle)?t.$parent.setItemContains(e.may_contain):t.setItemContains(!1)})})}]),reportsApp.controller("attribsCtrl",["$log","$scope",function(
e,t){t.cur_edit=-1,t.new_item=!1,angular.isArray(t.$parent.field.data[t.$parent.attr.aid])||(t.$parent.field.data[t.$parent.attr.aid]=[]),t.$parent.$watchCollection("field.data[attr.aid]",function(e){t.data=e;if(t.cur_edit<0)return;for(var n=0;n<e.length;n++)e[n]||e.splice(n--,1);t.cur_edit=-1}),t.$watch("new_item",function(){if(!t.new_item)return;t.data.push(t.new_item),t.new_item=!1,t.cur_edit=-1
}),t.remainingValues=function(e,n){var r=[];return angular.forEach(t.attr.values,function(t){if(angular.isArray(e)){var i=e.indexOf(t[0]);if(i>=0&&i!=n)return}r.push(t)}),r},t.visibleName=function(t,n){for(var r=0;r<n.length;r++)if(n[r][0]==t)return n[r][1];return e.warn("oops, no value",t,"in",n),t},t.setCurEdit=function(e){t.cur_edit=e}}]),reportsApp.controller("attribsCountCtrl",["$log","$scope"
,function(e,t){for(var n=t.$parent;n&&n.field===t.field;n=n.$parent);t.attribs=[],t.field.data||(t.field.data={}),t.field.data_op||(t.field.data_op={});var r="field.fields."+t.field.sub_path+".fields."+t.field.cat_path+".data";n.$watch(r,function(e){var r=n.field.fields[t.field.sub_path].fields[t.field.attribs_path];n.refreshCatData(e,r).then(function(e){t.field.attribs=r.attribs||[]})}),n.$watch("field.fields."+
t.field.sub_path+".fields."+t.field.attribs_path,function(){t.field.attribs=n.field.fields[t.field.sub_path].fields[t.field.attribs_path].attribs||[]})}]),reportsApp.controller("formattingCtrl",["$log","$scope",function(e,t){t.fmtTable=!1;var n=function(){t.fmtTable=[];if(!t.reportType.fields)return;angular.forEach(t.reportType.fields,function(e,n){t.setFieldFmt(e)&&e.fields&&e.fields.name&&(e.fmt.
display="name"),t.reportGroups.indexOf(e.full_path)==-1&&t.fmtTable.push(e),e.fmt.sub_fields&&angular.forEach(e.fmt.sub_fields,function(n){var r=t.fieldByPath(n,e);r&&t.reportGroups.indexOf(r.full_path)==-1&&t.fmtTable.push(r)})})},r=function(){if(!t.reportType)return;t.$parent.fillFieldPaths(),n()};t.$parent.$watchCollection("reportType.fields",r),t.$parent.$watchCollection("reportGroups",n),t.addGroup=
function(n){e.debug("addGroup",n,"to",t.reportGroups);var r=t.reportGroups.indexOf(n.full_path);return r>=0&&t.reportGroups.splice(r,1),t.reportGroups.push(n.full_path),!0},t.get_fmt_fields=function(e){var n=[];return e.fmt&&angular.forEach(e.fmt.sub_fields,function(r){n.push(t.fieldByPath(r,e))}),n.sort(function(e,t){return e.fmt.sequence-t.fmt.sequence||e.sequence-t.sequence}),n};var i=function(e
,n,r){e.fmt?(e.sequence>=n&&r.push(e),e.fmt.sub_fields&&angular.forEach(e.fmt.sub_fields,function(s){var o=t.fieldByPath(s,e);o&&i(o,n,r)})):e.sequence>=n&&r.push(e)},s=function(e,n,r){var i=r,s=r+1;while(i<s){for(var o=0;o<n.length;o++){if(n[o]===undefined)continue;var u;n[o].fmt?u=n[o].fmt.sequence:u=n[o].sequence;if(u==i){t.setFieldFmt(n[o]),n[o].fmt.sequence=s,n[o]=undefined,s++;break}}i++}t.setFieldFmt
(e),e.fmt.sequence=r};t.addToGroup=function(e,r,o){if(!r)return;if(!r.full_path.startsWith(e.full_path+"."))return!1;var u=r.full_path.slice(e.full_path.length+1);t.setFieldFmt(e),e.fmt.sub_fields||(e.fmt.sub_fields=[]);var a=1,f=[];o&&(o.fmt?a=o.fmt.sequence:a=o.sequence,a++),i(e,a,f);var l=e.fmt.sub_fields.indexOf(u);if(l==-1)r.fmt&&r.fmt.hide&&(r.fmt.hide=!1),e.fmt.sub_fields.push(u),s(r,f,a);else{
if(!(l>0))return!1;s(r,f,a)}return n(),!0},t.addToField=function(e,r){if(!e)return!1;if(e.full_path.indexOf(".")!=-1)return t.addToGroup(r,e);e.fmt&&e.fmt.hide&&(e.fmt.hide=!1);var o=t.reportGroups.indexOf(e.full_path);o!=-1&&t.reportGroups.splice(o,1);var u=1,a=[];return r&&(r.fmt?u=r.fmt.sequence:u=r.sequence,u++),angular.forEach(t.reportType.fields,function(e){i(e,u,a)}),s(e,a,u),n(),!0},t.removeField=
function(e){if(!e)return;var r=t.reportGroups.indexOf(e.full_path);if(r>=0)t.reportGroups.splice(r,1);else{if(e.full_path.indexOf(".")>=0){var i=e.full_path.split("."),s=[];while(i.length>1){s.unshift(i.pop());var o=t.fieldByPath(i.join("."));if(!o)break;if(!o.fmt||!o.fmt.sub_fields)continue;var u=o.fmt.sub_fields.indexOf(s.join("."));if(u>=0)return o.fmt.sub_fields.splice(u,1),n(),!0}return!1}e.path&&
e.path.startsWith("+")?delete t.reportType.fields[e.path]:(t.setFieldFmt(e),e.fmt.hide=!0)}return n(),!0}}]);var _calc_result_fields=function(e,t,n,r,i){var s=function(n,i){if(n.hide||n.widget=="isset")return;var o=this.req,u=this.ggroup;for(var a in e.reportGroups)if(n.full_path.startsWith(e.reportGroups[a])){n.full_path==e.reportGroups[a]&&(o=!0),r[a]||(r[a]=[]),u=r[a],e.setFieldFmt(n);break}if(o&&
n.fmt){var f=n.full_path,l=undefined;n.fmt.display&&(f+="."+n.fmt.display),n.fmt.hide||(n.path&&n.path.startsWith("+")?t.push([n.path,n.widget,n.data]):t.push(f)),n.fmt.order&&(n.fmt.order=="-"?l="-"+f:l=f),u&&!n.fmt.hide&&u.push({id:f,name:n.fmt.title||n.name,widget:n.widget,order:l,group_mode:n.fmt.group_mode,sequence:n.fmt.sequence||n.sequence})}n.fields&&angular.forEach(n.fields,function(e,t){var r=
{req:!1,ggroup:u};n.fmt&&n.fmt.sub_fields&&n.fmt.sub_fields.indexOf(t)>=0&&(r.req=!0),angular.bind(r,s)(e,t)})};angular.forEach(e.reportType.fields,s,{req:!0,ggroup:n}),n.sort(function(e,t){return e.sequence-t.sequence});for(var o in e.reportGroups){var u=[];angular.forEach(r[o],function(e){e.order&&u.push(e)}),u.length&&(u.sort(function(e,t){return e.sequence-t.sequence}),angular.forEach(u,function(
e){i.push(e.order)}))}angular.forEach(n,function(e){e.order&&i.push(e.order)})};reportsApp.controller("previewCtrl",["$log","$scope","$http","$timeout","$sce",function(e,t,n,r,i){t.wait_results=!0,t.result_status=0,t.result_alert=!1,t.cur_domain="?",t.results=!1;var s=function(e){t.wait_results=!0,t.result_status=0,t.result_alert=!1,t.results=!1,t.field_cols=[],t.groupped_fields={},t.order_by=[],t.
group_level=0,t.rowsFilter=function(){return!0};if(!e||!t.reportType)return;t.cur_domain=t.$parent.getCurDomain();var r=[];_calc_result_fields(t,r,t.field_cols,t.groupped_fields,t.order_by),n.post("./results-preview/"+t.reportType.id,{model:t.reportType.id,domain:t.cur_domain,fields:r,show_detail:t.reportType.show_detail,group_by:t.reportGroups,order_by:t.order_by,limit:t.reportType.preview_limit||10
}).success(function(e){t.wait_results=!1,e.count!==undefined?t.results=[{group_level:0,_count:e.count},{group_level:1,group_by:!1,values:e.results}]:t.results=e}).error(function(e,n,r){t.wait_results=!1,t.result_status=n,t.result_alert=i.trustAsHtml(e)})};t.$parent.$watch("tabs.preview",s)}]),reportsApp.controller("previewGroupedCtl",["$scope","$log","$filter","appWords",function(e,t,n,r){e.group_level=
e.$parent.group_level+1,e.cur_results=e.$parent.results[e.group_level];var i=!1;if(e.cur_results&&e.cur_results.group_by){var s=e.fieldByPath(e.reportGroups[e.$parent.group_level]);s?e.group_mode=s.fmt.group_mode||"row":e.group_mode="table"}else e.group_mode=!1;if(e.$parent.cur_group){var o={};angular.forEach(e.$parent.cur_results.group_by,function(t){o[t]=e.$parent.cur_group[t]}),e.rowsFilter=function(
e){for(var t in o)if(e[t]!=o[t])return!1;return!0}}if(e.group_mode=="left_col"){var u=[],a=n("seqSort");for(var f=e.group_level;f<=e.$parent.results.length;f++){var l=e.$parent.results[f+1];if(l&&l.group_by){var s=e.fieldByPath(e.reportGroups[f]);if(s&&s.fmt)if(s.fmt.group_mode=="table")angular.forEach(a(e.groupped_fields[f]),function(e){e.display_name===undefined&&(e.name=="-"?e.display_name="":e.
display_name=e.name),u.push(e)}),u.push({id:"_count",display_name:r.count});else{if(s.fmt.group_mode=="left_col"){var c=e.groupped_fields[f][0];c.display_name===undefined&&(c.name=="-"?c.display_name="":c.display_name=c.name),u.push(c);continue}u.push({id:"_results"})}break}l&&angular.forEach(e.field_cols,function(e){e.display_name===undefined&&(e.name=="-"?e.display_name="":e.display_name=e.name),
u.push(e)})}t.debug("getRightColumns:",u),e.right_cols=u}else e.right_cols=[]}]),reportsApp.controller("resultCtrl",["$log","$scope","$timeout",function(e,t,n){var r=0;t.rfpost_json="";var i=function(){angular.forEach($(".result-types form"),function(e){var n=e.action.lastIndexOf("?");n>0&&(e.action=e.action.substr(0,n)),e.action+="?",t.reportType&&t.reportType.saved_id&&(e.action+="id="+t.reportType
.saved_id+"&"),e.action+="n="+r.toString()})};t.$parent.prepareResultsPost=function(){if(!t.reportType)return;var e=[],n={},r=[],s=[];_calc_result_fields(t,r,e,n,s);var o={model:t.reportType.id,title:t.reportType.title||t.reportType.name,notes:t.reportType.notes,domain:t.$parent.getCurDomain(),fields:r,show_detail:t.reportType.show_detail,group_by:t.reportGroups,order_by:s,limit:t.reportType.limit,
field_cols:e,groupped_fields:n};return t.rfpost_json=angular.toJson(o),i(),!0},t.countSubmit=function(){r++,i()}}]),reportsApp.filter("seqSort",["$log",function(e){return function(e,t){if(!e)return[];var n=[];return angular.forEach(e,function(e){if(e.hide)return;if(t&&e.fmt&&e.fmt.hide)return;n.push(e)}),n.sort(function(e,t){return e.fmt!==undefined&&t.fmt!==undefined?e.fmt.sequence-t.fmt.sequence:
e.sequence-t.sequence}),n}}]),reportsApp.filter("hiddenOnly",function(){return function(e,t){if(!e)return[];var n=[];return angular.forEach(e,function(e){(e.hide||e.fmt&&e.fmt.hide)&&n.push(e)}),n}}),reportsApp.filter("seqCount",["$log",function(e){return function(e,t){if(!e)return[];var n=0;return angular.forEach(e,function(e){if(e.hide)return;n++}),t&&(n+=t),n}}]),reportsApp.filter("fmtBool",["appWords"
,function(e){return function(t){return e[t]}}]),reportsApp.filter("fmtHasSth",["appWords",function(e){return function(t){return e["has_"+t]}}]),reportsApp.filter("fmtAutoField",["appWords","$filter","$sce",function(e,t,n){var r=t("date");return function(t,n){var i=t[n.id];return n.id[0]=="+"&&(i=t[n.id.substr(1)]),n.widget=="boolean"?e[i]:n.widget=="has_sth"?e["has_"+i]:n.widget=="date"?r(i,"dd/MM/yyyy"
):n.widget=="extra_condition"?e[i]:n.widget=="extra_attrib"?i:i}}]),reportsApp.filter("date2iso",["$filter",function(e){var t=e("date");return function(e){return angular.isDate(e)?t(e,"yyyy-MM-dd"):e}}]);