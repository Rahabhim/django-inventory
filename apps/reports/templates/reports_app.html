{% extends "base.html" %}
{% load i18n %}
{% load online_help %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/reports-widgets.css" type="text/css" media="screen" />
{% endblock %}

{% block web_theme_javascript %}
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/angular.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/ui-bootstrap-tpls-0.10.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/f3-movable.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/f3-draggable.min.js"></script>
{% endblock %}

{% block web_theme_sidebar %}
    {% block sidebar %}
        <div class="block">
                <h3>{% trans 'Actions' %}</h3>
            <ul class="navigation">
                <li><a ng-click="reportLoad()"><span class="famfam active famfam-folder"></span>
                        {% trans 'Load' %}</a></li>
                <li ng-show="needs_save"><a ng-click="reportSave()"><span class="famfam active famfam-disk"></span>
                        {% trans 'Save' %}</a></li>
                <li ng-show="needs_save && can_delete"><a ng-click="reportSaveCopy()"><span class="famfam active famfam-disk_multiple"></span>
                        {% trans 'Save copy' %}</a></li>
                <li ng-show="can_delete"><a ng-click="reportDelete()"><span class="famfam active famfam-bin"></span>
                        {% trans 'Delete' %}</a></li>
            </ul>
        </div>
    {% endblock %}
    {% help_for "view" "sidebar" sidebar=1 %}
{% endblock %}

{%block angular_app %} ng-app="reportsApp" {% endblock %}
{% block content %}
<div id="ng-main-app">
    <div class="content" ng-controller="mainCtrl">
        <h1>{% trans 'Report builder' %} [[ reportType.title || reportType.name ]]</h1>
        

        <tabset>
            <tab heading="{% trans 'Report type' %}" active="tabs.type">
                <h3>{% trans 'Please select one of the available report types:' %}</h3>
                <div>
                    <div class="button-selection" ng-repeat="t in available_types|seqSort" ng-click="selectType(t)">
                        <span class="famfam active" ng-class="t.famfam"></span>[[ t.name ]]
                    </div>
                </div>
            </tab>

            <tab heading="{% trans 'Parameters' %}" active="tabs.params" disabled="!reportType">
                <h3>{% trans 'Search criteria for '%}[[ reportType.name ]] </h3>
                <div ng-controller="paramsCtrl" class="params-form">
                    <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
                </div>
            </tab>
            <tab heading="{% trans 'Formatting' %}" active="tabs.format" disabled="!reportType">
                <h3>{% trans 'Formatting style' %}</h3>
                <!-- Vertical pos: groupping 
                    Horizontal pos: order of columns
                -->
                <div class="formatting-form" ng-controller="formattingCtrl">
                    <table id="fmt-form-table">
                        <tr><th>&nbsp;</th><th colspan="[[ fmtTable.length ]]">Columns...</tr>
                        <tr ng-repeat="fname in reportGroups" ng-init="field=fieldByPath(fname)">
                            <th>{% trans 'Group' %} [[ $index + 1 ]]</th>
                            <td ng-draggable="true" ng-drag-model="field"
                                ng-click-send="field" ng-click-align="field-fmt-palette"
                                ng-droppable="true" ng-ondrop="addToGroup(field, dragItem)"
                                 class="add-after">[[field.full_name]]</td>
                            <td ng-repeat="field2 in get_fmt_fields(field)"
                                ng-draggable="true" ng-click-send="field2"
                                ng-droppable="true" ng-ondrop="addToGroup(field, dragItem, field2)"
                                class="add-after"
                                ng-click-align="field-fmt-palette">[[field2.name]]</td>
                        </tr>
                        <tr class="add-group"><th>{% trans 'Add group...' %}</th>
                            <td colspan="[[ fmtTable.length ]]" ng-droppable="true" ng-ondrop="addGroup(dragItem)">{% trans 'drag here to add group...' %}</td></tr>
                        <tr ng-class="{'no-details': !reportType.show_detail}"><th><input type="checkbox" ng-model="reportType.show_detail">{% trans 'detailed:'%}</th><td ng-repeat="field in fmtTable" ng-draggable="true" ng-drag-model="field">
                            <a ng-click-send="field" ng-click-align="field-fmt-palette">[[ field.full_name ]]</a></td>
                        </tr>
                        
                    </table>
                    <div id="fmt-trash" ng-droppable="true" ng-ondrop="removeField(dragItem)">
                        <span class="famfam active famfam-bin"></span>
                        {% trans 'Drag any field here to hide/ungroup' %}
                    </div>
                </div>
                <div move-hook id="field-fmt-palette" style="min-width: 300px;"
                        move-hook-yoffset="-2"
                        under="fmt-form-table" ng-click-receive="field">
                    <div class="popover bottom" style="display: block" >
                        <div class="arrow" style="left: 20px"></div>
                        <div class="popover-inner">
                            <h3 class="popover-title">{% trans 'Field:'%} [[ field.name ]]
                                <a ng-click="close()" style="float:right;" title="close">&times;</a>
                            </h3>
                            <div class="popover-content">
                                [[ field.full_path ]]
                                <div ng-if="field.hide">{% trans 'Hidden' %}</div>
                                <div>Pos: [[ field.sequence ]]</div>
                                <div ng-if="field.fields">
                                    Display: [[ field.fmt.display ]]

                                    <div class="more-fields">
                                        Additional fields:
                                        <div ng-repeat="field2 in field.fields" 
                                            ng-draggable="true" ng-drag-model="field2">
                                            [[ field2.name ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </tab>
            <tab heading="{% trans 'Preview' %}" active="tabs.preview" disabled="!reportType">
                <h3>Results</h3>
                <div ng-controller="previewCtrl">
                    {% if request.user.is_superuser %}
                        <div>Domain: [[ cur_domain ]]
                        </div>
                    {% endif %}
                    <div ng-show="wait_results">{% trans 'Please wait, calculating preview...' %}</div>
                    <div ng-if="results" class="preview-results">
                        <div ng-controller="previewGroupedCtl">
                            <div ng-include="'parts/preview-results.html'">???</div>
                            <div class="count">{% trans "Number of results:" %} [[ results[0]._count ]]</div>
                        </div>
                    </div>
                    <h4 ng-if="result_alert">Error [[ result_status ]] </h4>
                    <div ng-if="result_alert" ng-bind-html="result_alert">
                    </div>
                </div>
            </tab>
            <tab heading="{% trans 'Full results' %}" active="tabs.results" disabled="!reportType">
                <h3> full results</h3>
            </tab>
        </tabset>

    </div>
</div>

{% endblock %}

{% block web_theme_footer %}
    {{ block.super }}
<script type="text/ng-template" id="parts/field-model.html">
    <dl ng-repeat="field in field.fields|seqSort">
        <dt ng-click="field.expanded = !field.expanded">
            <span class="famfam active" ng-class="{'famfam-wrench': field.expanded, 'famfam-resultset_next': !field.expanded}"></span>
            [[ field.name ]]
        </dt>
        <dd ng-if="!field.expanded"> [[ formatParmsData(field) ]]</dd>
        <dd ng-if="field.expanded" class="expanded">
            <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
        </dd>
    </dl>
</script>

<script type="text/ng-template" id="parts/field-model-product.html">
    <div ng-controller="productParamsCtrl">
        <div ng-include="'parts/field-model.html'"></div>
    </div>
</script>

<script type="text/ng-template" id="parts/field-char.html">
    <input type="char" ng-model="field.data"></input>
</script>

<script type="text/ng-template" id="parts/field-.html">
    ???
</script>

<script type="text/ng-template" id="parts/field-isset.html">
    <select ng-model="field.data">
        <option value="">*</option>
        <option value="0">{% trans 'Empty' %}</option>
        <option value="1">{% trans 'Set' %}</option>
    </select>
</script>

<script type="text/ng-template" id="parts/field-lookup.html">
    <input ng-model="field.data" type="text" autocomplete="off"
        typeahead="d as d.repr for d in getLookup(field.lookup, $viewValue)"
        typeahead-editable="false">
</script>

<script type="text/ng-template" id="parts/field-selection.html">
    <select ng-model="field.data" ng-options="d[0] as d[1] for d in field.selection">
        <option value="">{% trans '(none)'%}</option>
    </select>
</script>

<script type="text/ng-template" id="parts/field-contains.html">
    <div ng-repeat="field in field.contains_data">
        {% trans 'containing:' %}
        <a ng-click="removeContains(field, $parent.field)">{% trans 'Remove' %}</a>
        <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
    </div>
    <div>
        <a ng-click="addContains(field)">{% trans 'Add more...' %}</a>
    </div>
</script>

<script type="text/ng-template" id="parts/field-attribs.html">
    <div ng-repeat="attr in field.attribs">
        <label ng-bind="attr.name"></label>
        <select ng-model="field.data[attr.aid]" ng-options="d[0] as d[1] for d in attr.values">
            <option value=""></option>
        </select>
    </div>
</script>

<script type="text/ng-template" id="parts/preview-results.html">
    <div ng-if="cur_results.group_by">
        <div class="group" ng-repeat="cur_group in cur_results.values|filter:rowsFilter">
            <h4><span ng-repeat="fc in groupped_fields[group_level-1]|seqSort"> [[ cur_group[fc.id] ]]</span>
                : [[ cur_group._count ]]</h4>
            <div ng-controller="previewGroupedCtl">
                <div ng-include="'parts/preview-results.html'"><!-- recursive --></div>
            </div>
        </div>
        <div class="group">
            <!-- In preview, there may be more groups, results -->
            <h4>... </h4>
        </div>
    </div>
    <div ng-if="cur_results && !(cur_results.group_by)">
        <table class="preview-results">
            <tr class="head">
                <th ng-repeat="fc in field_cols">[[fc.name ]]</th>
            </tr>
            <tr ng-repeat="row in cur_results.values|filter:rowsFilter">
                <td ng-repeat="fc in field_cols">[[ row[fc.id] ]]</td>
            </tr>
        </table>
    </div>
</script>
<script type="text/ng-template" id="parts/file-load.html">
    <div class="modal-header">
        <button style="float: right;" class="btn btn-link btn-mini" ng-click="$dismiss()">&times;</button>
        <h3>{% trans 'Load saved report' %}</h3>
    </div>
    <div class="modal-body">
        <div>{% blocktrans %}Select a report to load{% endblocktrans %}</div>
        <div style="overflow: auto;">
            <div ng-repeat="r in reports">
                <span class="famfam active famfam-report"></span><a ng-click="$close(r.id)">[[ r.title ]]</a>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button ng-click="$dismiss()" class="btn btn-primary">{% trans 'Cancel' %}</button>
    </div>
</script>

<script type="text/ng-template" id="parts/file-save.html">
    <div class="modal-header">
        <button style="float: right;" class="btn btn-link btn-mini" ng-click="$dismiss()">&times;</button>
        <h3>{% trans 'Save report' %}</h3>
    </div>
    <div class="modal-body">
        <div>{% trans 'Title' %}: <input ng-model="report.title" type="text"></div>
        {% if user.is_staff %}
        <div>
            <input type="checkbox" ng-model="report.public"><label>{% trans 'Public' %}</label>
        </div>
        {% endif %}
    </div>
    <div class="modal-footer">
        <button ng-show="has_btn && report.title" ng-click="do_save()" class="btn btn-success">{% trans 'Save' %}</button>
        <button ng-show="has_btn" ng-click="$dismiss()" class="btn btn-primary">{% trans 'Cancel' %}</button>
    </div>
</script>

<script type="text/ng-template" id="parts/file-delete.html">
    <div class="modal-header">
        <button style="float: right;" class="btn btn-link btn-mini" ng-click="$dismiss()">&times;</button>
        <h3>{% trans 'Delete report' %}</h3>
    </div>
    <div class="modal-body">
        <h4> [[ report.title ]]</h4>
        <div>{% blocktrans %}Do you really want to delete this report?{% endblocktrans %}</div>
        
    </div>
    <div class="modal-footer">
        <button ng-click="$close(report_id)" class="btn btn-delete">{% trans 'Delete' %}</button>
        <button ng-click="$dismiss()" class="btn btn-primary">{% trans 'Cancel' %}</button>
    </div>
</script>

<script type="text/javascript">
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}
    var reportsApp = angular.module('reportsApp', ['ui.bootstrap', 'f3.movable', 'f3.draggable'])
        .config(['$interpolateProvider', '$httpProvider', '$locationProvider',
          function($interpolateProvider, $httpProvider, $locationProvider) {
            $interpolateProvider.startSymbol('[[');
            $interpolateProvider.endSymbol(']]');
            $httpProvider.defaults.headers.post['X-CSRFToken'] = "{{ csrf_token }}";
            $locationProvider.html5Mode(false);
        }]);
    reportsApp.controller('mainCtrl', ['$log', '$scope', '$location', '$http', '$modal',
        function($log, $scope, $location, $http, $modal) {
            $log.debug("mainCtrl:", $scope);
            $scope.reportType = false;
            $scope.reportGroups = [];
            $scope.available_types = {{ available_types }};
            $scope.tabs = { 'type': true, 'params': false, 'format': false, 'preview': false, 'results': false };
            $scope.selectType = function(t) {
                    $log.debug("Selecting type:", t.id);
                    if (! t.id)
                        return;
                    $scope.reportType = t;
                    $location.search('id'); // reset it
                    $scope.$root.can_delete = false;
                    $scope.reportGroups = [];
                    $scope.tabs.params = true;

                    if (!t.fields){
                        $log.debug("Must fetch grammar for", t.id);
                        $http.get('grammar/'+t.id).success(function(data) {
                                $log.debug("Grammar data:", data);
                                angular.extend(t, data);
                            });
                        }
                };

            var domainFns = {
                /* Domain functions return an expression part for some field
                
                  The expression part is like ['op', <rhs>]
                */
                'model' : function(rt) {
                        var dom = [];
                        angular.forEach(rt.fields, function(rt2, n2) {
                            var dfn = domainFns[rt2.widget];
                            if (dfn === undefined)
                                dfn = domainFns['model']
                            var dom2 = dfn(rt2, n2);
                            if (dom2 && dom2.length){
                                if (dom2[0] == '&') {
                                    angular.forEach(dom2[1], function(dom3) {
                                        dom.push([n2, '=',].concat(dom3));
                                        });
                                }
                                else
                                    dom.push([n2].concat(dom2)) ;
                                }
                            });
                        if ((dom.length == 1) && (dom[0][0] == '_'))
                            return [ '=', dom[0][2]];
                        if (dom.length)
                            return ['in', dom];
                        return false;
                    },
                'char': function(rt, name) {
                        if (rt.data)
                            return [rt.data_op || 'icontains', rt.data];
                    },
                'lookup': function(rt, name) {
                        if (rt.data)
                            return ['=', parseInt(rt.data.pk)];
                    },
                'selection': function(rt, name) {
                        if (rt.data)
                            return ['=', parseInt(rt.data)];
                    },
                'attribs': function(rt, name) {
                        if (!rt.data)
                            return;
                        $log.debug("Atribs=> dom:", rt);
                        var rval = [];
                        angular.forEach(rt.data, function(val) {
                                rval.push(val);
                            });
                        if (rval.length)
                            return ['&', rval];
                    },
                'contains': function(rt, name) {
                        if (!rt.contains_data)
                            return;
                        var rdom = [];
                        angular.forEach(rt.contains_data, function(rt2) {
                            var dfn = domainFns[rt2.widget];
                            if (dfn === undefined)
                                dfn = domainFns['model']
                            var dom2 = dfn(rt2, name);
                            if (!(dom2 && dom2.length))
                                return;
                            if (dom2[0] == 'in' || dom2[0] == '='){
                                rdom.push(dom2[1]) ;
                            }
                            else if (dom2[0] == '&') {
                                angular.forEach(dom2[1], function(dom3) {
                                    rdom.push(dom3);
                                    });
                            }
                            else
                                $log.warn("Cannot use domain", dom2, "for", name);
                            });
                        return ['&', rdom];
                    },
                'isset': function(rt, name) {
                        if (rt.data){
                            if (rt.data == '0')
                                return ['=', false];
                            else
                                return ['=', true];
                        }
                    },
                };
            domainFns['model-product'] = domainFns['model'];
            $scope.getCurDomain = function(){
                if (!$scope.reportType)
                    return [];
                return domainFns['model']($scope.reportType);
                };
            /** Get field object by some dot-delimited path */
            $scope.fieldByPath = function(path, ffrom) {
                var ps = path.split('.');
                ps.reverse();
                var ret = ffrom || $scope.reportType;
                while(ps.length){
                    if (!ret.fields)
                        return;
                    ret = ret.fields[ps.pop()];
                    if (!ret) return;
                    }
                return ret;
                };
            $scope.setFieldFmt = function(field) {
                    field.fmt = {sequence: field.sequence, order: false};
                };

            var _getFieldData_one = function(field) {
                    var r = {};
                    if (field.data_op)
                        r['op'] = field.data_op;
                    if (field.data)
                        r['data'] = field.data;
                    if (field.fmt)
                        r['fmt'] = field.fmt;
                    if (field.fields)
                        r['fields'] = getFieldData(field.fields);
                    if (field.contains_data){
                        r['contains'] = [];
                        angular.forEach(field.contains_data, function(item){
                            r['contains'].push(_getFieldData_one(item));
                            });
                    }
                    return r;
                };
            var getFieldData = function(fields) {
                // extract the volatile field data from field.data
                var ret = {};
                angular.forEach(fields, function(field, key){
                    ret[key] = _getFieldData_one(field);
                    });
                return ret;
                };

            var _setFieldData_one = function(src, target){
                if (src.op)
                    target.data_op = src.op;
                if (src.data)
                    target.data = src.data;
                if (src.fmt)
                    target.fmt = src.fmt;
                if (src.fields)
                    setFieldData(src.fields, target.fields);
                if (src.contains){
                    target.contains_data = [];
                    angular.forEach(src.contains, function(item) {
                        var t_item = angular.copy(target.sub);
                        _setFieldData_one(item, t_item);
                        target.contains_data.push(t_item);
                        });
                    }
                };
            var setFieldData = function(fields, target){
                angular.forEach(fields, function(field, key){
                    _setFieldData_one(field, target[key]);
                    });
                };

            var _loadReport = function(rid) { 
                        $log.debug("Load report:", rid);
                        $http.get('back/load', {'params': {'id': rid}})
                            .success(function(data){
                                $log.debug("load data came:", data);
                                $scope.reportType = data.grammar;
                                $scope.reportType.saved_id = data.id;
                                $location.search('id', data.id);
                                $scope.reportType.id = data.model;
                                $scope.reportType.public = data.public;
                                $scope.reportType.title = data.title;
                                $scope.reportType.show_detail = data.data.show_detail;
                                $scope.reportGroups = data.data.groups || [];

                                setFieldData(data.data.fields, $scope.reportType.fields);
                                $scope.$root.needs_save = false;
                                $scope.$root.can_delete = true;
                                })
                            .error(function(data, status, headers) {
                                    $log.debug("Load error:", data, status);
                                    $location.search('id');
                                    });
                    };

            $scope.$root.reportLoad = function() {
                var minst = $modal.open({
                    templateUrl: 'parts/file-load.html',
                    controller: ['reports', '$scope', function(reports, $scope) {
                            $scope.reports = reports;
                        }],
                    windowClass: 'load-dlg',
                    backdrop: 'static',
                    resolve: { 'reports': function() {
                        return $http.get('back/list')
                            .then(function(response){
                                if (response.status == 200)
                                    return response.data;
                                else{
                                    $log.error("list response:", response);
                                    throw Error(response.status);
                                    }
                                });
                            }
                        }});

                minst.result.then(_loadReport);
                };

            $scope.$root.reportSave = function() {
                var minst = $modal.open({
                    templateUrl: 'parts/file-save.html',
                    controller: ['$scope', 'report', 'reportGroups', '$timeout',
                      function($scope, report, reportGroups, $timeout) {
                        $scope.has_btn = true;
                        $scope.message = '';
                        $scope.report = report;
                        $scope.reportGroups = reportGroups;
                        $scope.do_save = function() {
                            // serialize reportType + reportGroups into data for report
                            var ser = { 'title': $scope.report.title,
                                        'model': $scope.report.id,
                                        'public': $scope.report.public || false,
                                        'data': {'groups': reportGroups,
                                                'fields': getFieldData($scope.report.fields),
                                                'show_detail': $scope.report.show_detail
                                                },
                                        };
                            if ($scope.report.saved_id)
                                ser['id'] = $scope.report.saved_id;
                            $scope.has_btn = false;
                            $http.post('back/save', ser)
                                .success(function(data) {
                                    $log.debug("Saved report:", data);
                                    $scope.message = 'OK';
                                    $scope.report.saved_id = data.id;
                                    $scope.$root.can_delete = true;
                                    $timeout($scope.$dismiss, 1000);
                                })
                                .error(function(data, status, headers) {
                                    $log.debug("Error:", data, status);
                                    });
                            };
                        }],
                    windowClass: 'save-dlg',
                    backdrop: 'static',
                    resolve: { 'report': function() { return $scope.reportType; },
                                'reportGroups': function() { return $scope.reportGroups },
                        }});

                minst.result.then(function() { $log.debug("Modal closed!") });
                };
            $scope.$root.reportSaveCopy = function() {
                $scope.reportType.saved_id = undefined;
                if ($scope.reportType.title)
                    $scope.reportType.title += ' (copy)';
                return $scope.reportSave();
                };

            $scope.$root.reportDelete = function() {
                var minst = $modal.open({
                    templateUrl: 'parts/file-delete.html',
                    controller: ['report_id', '$scope', function(report_id, $scope) {
                            $scope.report_id = report_id;
                        }],
                    windowClass: 'delete-dlg',
                    backdrop: 'static',
                    resolve: { 'report_id': function() { return $scope.reportType.saved_id; }
                        }});

                minst.result.then(function(rid) {
                    if (rid)
                        $http.post('back/delete', {'id': rid, 'confirm': true})
                            .success(function() {
                                $scope.reportType = false;
                                $scope.reportGroups = false;
                                $scope.$root.can_delete = false;
                                $scope.$root.needs_save = false;
                                })
                            .error(function(data, status, headers) {
                                    $log.debug("Error:", data, status);
                                    });
                    });
                };
            $scope.$watch(function() { return $location.search().id; },
                function(report_id){
                    if ((!report_id) || (report_id === true))
                        return;
                    if (report_id == $scope.reportType.saved_id)
                        return;
                    _loadReport(report_id);
                });
        }]);

    reportsApp.controller('reportsTypeCtrl', ['$log', '$scope',function($log, $scope) {
            $log.debug("reportsTypeCtrl:", $scope);

            $scope.view_short = false;
            $scope.type_name = '?';
        }]);

    reportsApp.controller('paramsCtrl', ['$log', '$scope','$http',
        function($log, $scope, $http) {
            $log.debug("paramsCtrl:", $scope);
            $scope.field = false;
            $scope.$parent.$watch('reportType', function(rt){
                    $log.debug("reportType changed:", rt);
                    $scope.field = rt;
                    if (rt)
                        $scope.$root.needs_save = true;
                });

            var formatFns = {
                    'char': function(field) {
                        if (field.data)
                            return '"' +field.data.toString() + '"';
                        },
                    'model': function(field) {
                        var criteria = [];
                        angular.forEach(field.fields, function(fld, k) {
                            var c = $scope.formatParmsData(fld);
                            if (c)
                                criteria.push(fld.name +': ' + c);
                            });
                        if (criteria.length)
                            return '[' + criteria.join(', ') + ']';
                        },
                    'lookup': function(field) {
                        if (field.data)
                            return field.data.repr;
                        },
                    'selection': function(field) {
                        if (field.data){
                            for(var i in field.selection)
                                if(field.selection[i][0] == field.data)
                                    return field.selection[i][1];
                            }
                        },
                    'attribs': function(field) {
                        var criteria = [];
                        angular.forEach(field.attribs, function(attr) {
                            var v = field.data[attr.aid]; // TODO: turn into array
                            if (!v)
                                return;
                            for(var i=0;i<attr.values.length; i++)
                                if (attr.values[i][0] == v)
                                    criteria.push(attr.name+'='+attr.values[i][1]);
                            });
                        if (criteria.length)
                            return criteria.join(',');
                        return "";
                        },
                    'contains': function(field) {
                            var criteria = [];
                            angular.forEach(field.contains_data, function(fld) {
                                var c = $scope.formatParmsData(fld);
                                if (c)
                                    criteria.push('+ ' + c);
                                });
                            if (criteria.length)
                                return criteria.join(', ');
                            return "";
                        },
                    'isset': function(field) {
                        if (field.data){
                            if (field.data == '0')
                                return "empty";
                            else
                                return "set";
                            }
                        return "";
                        }
                };
            formatFns['model-product'] = formatFns['model'];

            $scope.formatParmsData = function(field) {
                    var fn = formatFns[field.widget];
                    if (!fn)
                        $log.debug("No format function for", field.widget);
                    else
                        return fn(field);
                };

            $scope.addContains = function(field) {
                if (!field.contains_data)
                    field.contains_data = [];
                field.contains_data.push(angular.copy(field.sub));
                };
            $scope.removeContains = function(field, parent_field) {
                $log.debug("remove", field, "from", parent_field);
                var i = parent_field.contains_data.indexOf(field);
                if (i >= 0)
                    parent_field.contains_data.splice(i, 1);
                };

            $scope.getLookup = function(lookup, val) {
                return $http.get(lookup, {'params': {'term': val } })
                    .then(function(response) {
                        if (response.status == 200)
                            return response.data;
                        else
                            $log.error("lookup response:", response);
                            return [];
                        });
                };
            $scope.setItemContains = function() {}; // stub
        }]);

    reportsApp.controller('productParamsCtrl', ['$log', '$scope', '$http', function($log, $scope, $http) {
            $log.debug("productParamsCtrl:", $scope);

            $scope.$watch('field.fields.category.data', function(cat_data) {
                var fields = $scope.field.fields;
                if (cat_data) {
                    $http.get('./cat-grammar/'+cat_data.pk).then(function(response) {
                        if (response.status == 200){
                            var d = response.data;
                            if (d.is_group || d.is_bundle)
                                $scope.$parent.setItemContains(d.may_contain);
                            if (d.attributes && d.attributes.length){
                                fields.attributes.hide = false;
                                fields.attributes.attribs = d.attributes;
                                fields.attributes.data = {};
                            }
                        }
                        else
                            $log.warn("Bad http response:", response)
                        });

                } else {
                    /* no category selected, cleanup attributes and sibling "containing" */
                    if (fields && fields.attributes){
                        fields.attributes.hide = true;
                        fields.attributes.data = false;
                        }
                    $scope.$parent.setItemContains(false);
                    }
            });
        }]);

    reportsApp.controller('formattingCtrl', ['$log', '$scope',function($log, $scope) {
            $log.debug("formattingCtrl:", $scope);
            $scope.fmtTable = false;
            var fillFieldPaths = function(field, key){
                if (!field.full_path){
                    field.full_name = this.name_prefix + field.name;
                    field.full_path = this.fld_prefix + key;
                }
                if (field.fields)
                    angular.forEach(field.fields, fillFieldPaths,
                            { name_prefix: field.full_name + ' / ',
                              fld_prefix: field.full_path+ '.'
                            });
            };
            var recalcFmtTable = function(fields, fld_prefix) {
                $scope.fmtTable = [];
                if (!fields)
                    return;

                angular.forEach(fields, function(field, key) {
                        if (field.fmt === undefined) {
                            $scope.setFieldFmt(field);
                            if (field.fields && field.fields['name'])
                                field.fmt.display = 'name';
                        }
                        $scope.fmtTable.push(field);
                    });
                angular.forEach(fields, fillFieldPaths, {name_prefix: '', fld_prefix: ''});

                $scope.fmtTable.sort(function(a, b) {
                        return (a.fmt.sequence - b.fmt.sequence)
                            || (a.sequence - b.sequence);
                    });
                };
            $scope.$parent.$watch('reportType.fields', recalcFmtTable);

            $scope.addGroup = function(dragItem) {
                    $log.debug("addGroup", dragItem, "to", $scope.reportGroups);
                    var grp_idx = $scope.reportGroups.indexOf(dragItem.full_path)
                    if (grp_idx >=0){
                        // move to bottom of groupping
                        $scope.reportGroups.splice(grp_idx, 1);
                    }
                    /* TODO: check that parents of this field are not already in groups */
                    $scope.reportGroups.push(dragItem.full_path);
                    return true;
                };
            $scope.get_fmt_fields = function(field) {
                    var ret = [];
                    if (field.fmt)
                        angular.forEach(field.fmt.sub_fields, function(sfn) {
                            ret.push($scope.fieldByPath(sfn, field));
                        });
                    ret.sort(function(a,b) {
                            return (a.fmt.sequence - b.fmt.sequence)
                            || (a.sequence - b.sequence);
                        });
                    return ret;
                };
            $scope.addToGroup = function(grp_field, dragItem, fld_after){
                if (!dragItem.full_path.startsWith(grp_field.full_path+'.'))
                    return false;
                
                var rem_path = dragItem.full_path.slice(grp_field.full_path.length+1);
                if (!grp_field.fmt)
                    $scope.setFieldFmt(grp_field);
                if (!grp_field.fmt.sub_fields)
                    grp_field.fmt.sub_fields = [];
                var i = grp_field.fmt.sub_fields.indexOf(rem_path);
                if (i == -1){
                    grp_field.fmt.sub_fields.push(rem_path);
                    return true;
                }
                else if (i > 0){
                }
                return false;

                };
            $scope.removeField = function(dragItem) {
                    var grp_idx = $scope.reportGroups.indexOf(dragItem.full_path);
                    if (grp_idx >= 0) {
                        $scope.reportGroups.splice(grp_idx, 1);
                    }
                    else {
                        // not groupped, just hide the field
                        if (!dragItem.fmt)
                            $scope.setFieldFmt(dragItem);
                        dragItem.fmt.hide = true;
                        }
                    return true;
                };
        }]);


    reportsApp.controller('previewCtrl', ['$log', '$scope', '$http', '$timeout', '$sce',
        function($log, $scope, $http, $timeout, $sce) {
            $log.debug("previewCtrl:", $scope);
            $scope.wait_results = true;
            $scope.result_status = 0;
            $scope.result_alert = false;
            $scope.cur_domain = '?';
            $scope.results = false;
            $scope.grp_fields = false;

            var fetchResults = function(show) {
                $scope.wait_results = true;
                $scope.result_status = 0;
                $scope.result_alert = false;
                $scope.results = false;
                $scope.field_cols = [];
                $scope.groupped_fields = {};
                $scope.group_level = 0;
                $scope.grp_fields = [];
                $scope.rowsFilter = function() { return true; };

                if (!(show && $scope.reportType)){
                    return;
                }

                $scope.cur_domain = $scope.$parent.getCurDomain();
                var req_fields = [];
                var calc_get_fields = function(field, key) {
                    if (field.hide)
                        return;
                    var req2 = this.req;
                    // ggroup is where the field shall be displayed,
                    // may be empty for non-visible sub-fields
                    var ggroup = this.ggroup;
                    if (!ggroup){
                        // see if field logically belongs to any of the groups
                        for(var i in $scope.reportGroups)
                            if(field.full_path.startsWith($scope.reportGroups[i])){
                                if (!$scope.groupped_fields[i])
                                    $scope.groupped_fields[i] = [];
                                ggroup = $scope.groupped_fields[i];
                                if (!field.fmt)
                                    $scope.setFieldFmt(field);
                                break;
                            }
                    }
                    if (req2 && field.fmt){
                        var disp = field.full_path;
                        if (field.fmt.display)
                            disp += '.' + field.fmt.display;
                        req_fields.push(disp);
                        if (ggroup)
                            ggroup.push({id: disp,
                                name: field.name,
                                sequence: field.fmt.sequence || field.sequence});
                    }

                    if (field.fields)
                        angular.forEach(field.fields, function(field2, sf_name) {
                            var b = {req:false, group: ggroup};
                            if (field.fmt && field.fmt.sub_fields
                                    && (field.fmt.sub_fields.indexOf(sf_name) >=0))
                                b.req = true;
                            angular.bind(b, calc_get_fields)(field2, sf_name);
                            });

                    };

                angular.forEach($scope.reportType.fields, calc_get_fields,
                                {req: true, ggroup: $scope.field_cols});
                $scope.field_cols.sort(function(a, b) { return a.sequence - b.sequence; });

                $http.post('./results-preview/' + $scope.reportType.id,
                        {'model': $scope.reportType.id,
                        'domain': $scope.cur_domain,
                        'fields': req_fields,
                        'show_detail': $scope.reportType.show_detail,
                        'group_by': $scope.reportGroups,
                        }
                    )
                    .success(function(data) {
                        $log.debug("Preview data came:", data);
                        $scope.wait_results = false;
                        if (data.count){
                            $scope.results = [{'group_level': 0, _count: data.count},
                                        {'group_level': 1, 'group_by': false,
                                        'values': data.results }];
                        } else {
                            $scope.results = data;
                        }
                    })
                    .error(function(data, status, headers) {
                        $scope.wait_results = false;
                        $scope.result_status = status;
                        $scope.result_alert = $sce.trustAsHtml(data);
                        });
                };
            $scope.$parent.$watch('tabs.preview', fetchResults);
        }]);

    reportsApp.controller('previewGroupedCtl', ['$scope', '$log', function($scope, $log) {
            // Must be kept minimal, we will have many instances of this ctrl.
            $scope.group_level = $scope.$parent.group_level + 1;
            $scope.cur_results = $scope.$parent.results[$scope.group_level];
            if ($scope.$parent.cur_group){
                var group_filter = {};
            
                angular.forEach($scope.$parent.cur_results.group_by, function(group_by){
                        group_filter[group_by] = $scope.$parent.cur_group[group_by];
                    });
                $scope.rowsFilter = function(row) {
                    for(var k in group_filter){
                        if(row[k] != group_filter[k])
                            return false;
                    }
                    return true;
                };
            }
        }]);

    reportsApp.controller('resultCtrl', ['$log', '$scope',function($log, $scope) {
            $log.debug("resultCtrl:", $scope);
        }]);

    /* We need an explicit sort filter, because our input is an object, rather than
        an array. Then, we hard-code the 'sequence' criterion
    */
    reportsApp.filter('seqSort', ['$log', function($log) {
        return function(input){
            if (!input)
                return [];

            var ret = [];
            angular.forEach(input, function(f) {
                if (f.hide)
                    return;
                ret.push(f);
                });
            ret.sort(function(a, b) { return a.sequence - b.sequence });
            return ret;
        }
    }]);
</script>
{% endblock %}