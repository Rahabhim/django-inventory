{% extends "base.html" %}
{% load i18n %}
{% load online_help %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/reports-widgets.css" type="text/css" media="screen" />
{% endblock %}

{% block web_theme_javascript %}
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/angular.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/ui-bootstrap-tpls-0.10.0.min.js"></script>
{% endblock %}

{% block web_theme_sidebar %}
    {% block sidebar %}{% endblock %}
    {% help_for "view" "sidebar" sidebar=1 %}
{% endblock %}

{%block angular_app %} ng-app="reportsApp" {% endblock %}
{% block content %}
<div id="ng-main-app">
    <div class="content" ng-controller="mainCtrl">
        <h1>{% trans 'Report builder' %}</h1>
        

        <tabset>
            <tab heading="{% trans 'Report type' %}" active="tabs.type">
                <h3>{% trans 'Please select one of the available report types:' %}</h3>
                <div>
                    <div class="button-selection" ng-repeat="t in available_types|seqSort" ng-click="selectType(t)">
                        <span class="famfam active" ng-class="t.famfam"></span>[[ t.name ]]
                    </div>
                </div>
            </tab>

            <tab heading="{% trans 'Parameters' %}" active="tabs.params" disabled="!reportType">
                <h3>{% trans 'Search criteria for '%}[[ reportType.name ]] </h3>
                <div ng-controller="paramsCtrl" class="params-form">
                    <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
                </div>
            </tab>
            <tab heading="{% trans 'Formatting' %}" active="tabs.format" disabled="!reportType">
                <h3>{% trans 'Formatting style' %}</h3>
                <!-- Vertical pos: groupping 
                    Horizontal pos: order of columns
                -->
                <div class="formatting-form" ng-controller="formattingCtrl">
                    <table >
                        <tr><th>&nbsp;</th><th colspan="[[ fmtTable.length ]]"></tr>
                        <tr><th>group 1</th><td ng-repeat="field in fmtTable">[[ field.name ]]</td></tr>
                        <tr><th>Add group...</th><td colspan="[[ fmtTable.length ]]">{% trans 'drag here to add group...' %}</td></tr>
                    </table>
                </div>
            </tab>
            <tab heading="{% trans 'Preview' %}" active="tabs.format" disabled="!reportType">
            </tab>
            <tab heading="{% trans 'Full results' %}" active="tabs.format" disabled="!reportType">
            </tab>
        </tabset>

    <!--
        <span class="famfam active famfam-report"></span>
        <div class="block" ng-controller="reportsTypeCtrl">
            <h2>{% trans 'Type of report' %}</h2>
            <div ng-show="view_short">
                <h3 ng-click="view_short=false"><span class="famfam active" ng-class="current.famfam"></span>[[ current.name ]]</h3>
            </div>
            

            <div ng-if="view_short && current" ng-include="'parts/params-'+ current.id +'.html'">
            </div>
        </div>

        
        <div class="block" ng-show="show_params" ng-controller="paramsCtrl">
            <h2>{% trans 'Parameters' %}<h2>
        </div>
    </div>
    <hr/>
    <div class="content" ng-show="show_result" ng-controller="resultCtrl">
        <h1>{% trans 'Result' %}</h1>

        <hr/>
    -->
    </div>
</div>

{% endblock %}

{% block web_theme_footer %}
    {{ block.super }}
<script type="text/ng-template" id="parts/field-model.html">
    <dl ng-repeat="field in field.fields|seqSort">
        <dt ng-click="field.expanded = !field.expanded">
            <span class="famfam active" ng-class="{'famfam-wrench': field.expanded, 'famfam-resultset_next': !field.expanded}"></span>
            [[ field.name ]]
        </dt>
        <dd ng-if="!field.expanded"> [[ formatParmsData(field) ]]</dd>
        <dd ng-if="field.expanded" class="expanded">
            <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
        </dd>
    </dl>
</script>

<script type="text/ng-template" id="parts/field-model-product.html">
    <div ng-controller="productParamsCtrl">
        <div ng-include="'parts/field-model.html'"></div>
    </div>
</script>

<script type="text/ng-template" id="parts/field-char.html">
    <input type="char" ng-model="field.data"></input>
</script>

<script type="text/ng-template" id="parts/field-.html">
    ???
</script>

<script type="text/ng-template" id="parts/field-lookup.html">
    <input ng-model="field.data" type="text" autocomplete="off"
        typeahead="d as d.repr for d in getLookup(field.lookup, $viewValue)"
        typeahead-editable="false">
</script>

<script type="text/ng-template" id="parts/field-contains.html">
    <div ng-repeat="field in field.contains_data">
        {% trans 'containing:' %}
        <a ng-click="removeContains(field, $parent.field)">{% trans 'Remove' %}</a>
        <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
    </div>
    <div>
        <a ng-click="addContains(field)">{% trans 'Add more...' %}</a>
    </div>
</script>

<script type="text/ng-template" id="parts/field-attribs.html">
    <div ng-repeat="attr in field.attribs">
        <label ng-bind="attr.name"></label>
        <select ng-model="field.data[attr.aid]" ng-options="d[0] as d[1] for d in attr.values">
            <option value=""></option>
        </select>
    </div>
</script>

<script type="text/ng-template" id="parts/params-product.html">
    <section class="search">
    <dl><dt>{% trans 'Products' %}:</dt>
        <dd>[['foo' ]]</dd>
    </dl>
    <div ng-show="true">
        <h3>{% trans 'Criteria' %}</h3>
        <div class="criterion" ng-repeat="crit in criteria">
            <a class="del-criterion" ng-click="removeFromArray(criteria, crit)"><span class="famfam active famfam-delete"></span>{% trans 'Remove' %}</a>
        </div>
        <div class="add-criterion">
            <a ng-click="" ><span class="famfam active famfam-plus"></span>{% trans 'Add criterion...' %}</a>
        </div>
    </div>
    </section>
</script>

<script type="text/ng-template" id="parts/params-equipment.html">
    {# Equipment search includes Departments, Products, Procurements etc. #}
    <section class="search">
    <dl><dt>{% trans 'Equipment' %}:</dt>
         <dd>[['foo' ]]</dd>
    </dl>

    <div ng-controller="paramsCtrl">
        <div ng-include="'parts/params-product.html'"></div>
    </div>
    </section>

</script>

<script type="text/javascript">
    var reportsApp = angular.module('reportsApp', ['ui.bootstrap'])
        .config(['$interpolateProvider', function($interpolateProvider) {
            $interpolateProvider.startSymbol('[[');
            $interpolateProvider.endSymbol(']]');
        }]);
    reportsApp.controller('mainCtrl', ['$log', '$scope', '$http',function($log, $scope, $http) {
            $log.debug("mainCtrl:", $scope);
            $scope.reportType = false;
            $scope.available_types = {{ available_types }};
            $scope.tabs = { 'type': true, 'params': false, 'format': false, 'preview': false, 'results': false };
            $scope.selectType = function(t) {
                    $log.debug("Selecting type:", t.id);
                    if (! t.id)
                        return;
                    $scope.reportType = t;
                    $scope.tabs.params = true;

                    if (!t.fields){
                        $log.debug("Must fetch grammar for", t.id);
                        $http.get('grammar/'+t.id).success(function(data) {
                                $log.debug("Grammar data:", data);
                                angular.extend(t, data);
                            });
                        }
                };
        }]);

    reportsApp.controller('reportsTypeCtrl', ['$log', '$scope',function($log, $scope) {
            $log.debug("reportsTypeCtrl:", $scope);

            $scope.view_short = false;
            $scope.type_name = '?';
        }]);

    reportsApp.controller('paramsCtrl', ['$log', '$scope','$http',
        function($log, $scope, $http) {
            $log.debug("paramsCtrl:", $scope);
            $scope.field = false;
            $scope.$parent.$watch('reportType', function(rt){
                    $log.debug("reportType changed:", rt);
                    $scope.field = rt;
                });

            var formatFns = {
                    'char': function(field) {
                        if (field.data)
                            return '"' +field.data.toString() + '"';
                        },
                    'model': function(field) {
                        var criteria = [];
                        angular.forEach(field.fields, function(fld, k) {
                            var c = $scope.formatParmsData(fld);
                            if (c)
                                criteria.push(fld.name +': ' + c);
                            });
                        if (criteria.length)
                            return '[' + criteria.join(', ') + ']';
                        },
                    'lookup': function(field) {
                        if (field.data)
                            return field.data.repr;
                        },
                    'attribs': function(field) {
                        var criteria = [];
                        angular.forEach(field.attribs, function(attr) {
                            var v = field.data[attr.aid]; // TODO: turn into array
                            if (!v)
                                return;
                            for(var i=0;i<attr.values.length; i++)
                                if (attr.values[i][0] == v)
                                    criteria.push(attr.name+'='+attr.values[i][1]);
                            });
                        if (criteria.length)
                            return criteria.join(',');
                        return "";
                        },
                };
            formatFns['model-product'] = formatFns['model'];

            $scope.formatParmsData = function(field) {
                    var fn = formatFns[field.widget];
                    if (!fn)
                        $log.debug("No format function for", field.widget);
                    else
                        return fn(field);
                };

            $scope.addContains = function(field) {
                if (!field.contains_data)
                    field.contains_data = [];
                field.contains_data.push(angular.copy(field.sub));
                };
            $scope.removeContains = function(field, parent_field) {
                $log.debug("remove", field, "from", parent_field);
                var i = parent_field.contains_data.indexOf(field);
                if (i >= 0)
                    parent_field.contains_data.splice(i, 1);
                };

            $scope.getLookup = function(lookup, val) {
                return $http.get(lookup, {'params': {'term': val } })
                    .then(function(response) {
                        if (response.status == 200)
                            return response.data;
                        else
                            $log.error("lookup response:", response);
                            return [];
                        });
                };
            $scope.setItemContains = function() {}; // stub
        }]);

    reportsApp.controller('productParamsCtrl', ['$log', '$scope', '$http', function($log, $scope, $http) {
            $log.debug("productParamsCtrl:", $scope);

            $scope.$watch('field.fields.category.data', function(cat_data) {
                $log.debug("Category data changed:", cat_data);
                var fields = $scope.field.fields;
                if (cat_data) {
                    $http.get('./cat-grammar/'+cat_data.pk).then(function(response) {
                        if (response.status == 200){
                            var d = response.data;
                            if (d.is_group || d.is_bundle)
                                $scope.$parent.setItemContains(d.may_contain);
                            if (d.attributes && d.attributes.length){
                                fields.attributes.hide = false;
                                fields.attributes.attribs = d.attributes;
                                fields.attributes.data = {};
                            }
                        }
                        else
                            $log.warn("Bad http response:", response)
                        });

                } else {
                    /* no category selected, cleanup attributes and sibling "containing" */
                    if (fields && fields.attributes){
                        fields.attributes.hide = true;
                        fields.attributes.data = false;
                        }
                    $scope.$parent.setItemContains(false);
                    }
            });
        }]);

    reportsApp.controller('formattingCtrl', ['$log', '$scope',function($log, $scope) {
            $log.debug("formattingCtrl:", $scope);
            $scope.fmtTable = false;
            var recalcFmtTable = function(fields) {
                $scope.fmtTable = [];
                if (!fields)
                    return;

                angular.forEach(fields, function(field) {
                        if (field.fmt === undefined)
                            field.fmt = {group: 1, order: 1};
                        if (field.fmt.group > 0)
                            $scope.fmtTable.push(field);
                    });
                $scope.fmtTable.sort(function(a, b) {
                        return (a.fmt.group - b.fmt.group)
                            || (a.fmt.order - b.fmt.order)
                            || (a.sequence - b.sequence);
                    });
                };
            $scope.$parent.$watch('reportType.fields', recalcFmtTable);
        }]);
    reportsApp.controller('resultCtrl', ['$log', '$scope',function($log, $scope) {
            $log.debug("resultCtrl:", $scope);
        }]);

    /* We need an explicit sort filter, because our input is an object, rather than
        an array. Then, we hard-code the 'sequence' criterion
    */
    reportsApp.filter('seqSort', ['$log', function($log) {
        return function(input){
            if (!input)
                return [];

            var ret = [];
            angular.forEach(input, function(f) {
                if (f.hide)
                    return;
                ret.push(f);
                });
            ret.sort(function(a, b) { return a.sequence - b.sequence });
            return ret;
        }
    }]);
</script>
{% endblock %}