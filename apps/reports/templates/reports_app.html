{% extends "base.html" %}
{% load i18n %}
{% load online_help %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/reports-widgets.css" type="text/css" media="screen" />
{% endblock %}

{% block web_theme_javascript %}
{% if DEVELOPMENT %}
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/angular.js"></script>
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/ui-bootstrap-tpls-0.10.0.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/f3-movable.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/f3-draggable.js"></script>
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/reports-app.js"></script>
{% else %}
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/angular.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/ui-bootstrap-tpls-0.10.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/f3-movable.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/f3-draggable.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/reports-app.min.js"></script>
{% endif %}
{% endblock %}

{% block web_theme_sidebar %}
    {% block sidebar %}
        <div class="block">
                <h3>{% trans 'Actions' %}</h3>
            <ul class="navigation">
                <li><a ng-click="reportLoad()"><span class="famfam active famfam-folder"></span>
                        {% trans 'Load' %}</a></li>
                <li ng-show="needs_save && can_save"><a ng-click="reportSave()"><span class="famfam active famfam-disk"></span>
                        {% trans 'Save' %}</a></li>
                <li ng-show="needs_save && can_delete"><a ng-click="reportSaveCopy()"><span class="famfam active famfam-disk_multiple"></span>
                        {% trans 'Save copy' %}</a></li>
                <li ng-show="can_delete"><a ng-click="reportDelete()"><span class="famfam active famfam-bin"></span>
                        {% trans 'Delete' %}</a></li>
            </ul>
        </div>
    {% endblock %}
    {% help_for "view" "sidebar" sidebar=1 %}
{% endblock %}

{%block angular_app %} ng-app="reportsApp" {% endblock %}
{% block content %}
<div id="ng-main-app">
    <div class="content" ng-controller="mainCtrl" ng-cloak>
        <h1>{% trans 'Report builder' %}: [[ reportType.title || reportType.name ]]</h1>

        <tabset>
            <tab heading="{% trans 'Report type' %}" active="tabs.type">
                <h3 ng-show="!reportType">{% trans 'Please select one of the available report types:' %}</h3>
                <h3 ng-show="reportType">{% trans 'Selected report type' %}</h3>
                <div id="warn-report-type" ng-show="show_warning">{% blocktrans %}
                    By changing the report type, you may lose any configuration you
                    have done in the other tabs. Please double click to confirm.
                    {% endblocktrans %}
                </div>
                <div id="select-report-type" ng-class="{'no-report': !reportType}">
                    <div ng-repeat="t in available_types|seqSort">
                        <div class="button-selection" ng-class="{'selected': (t.id == reportType.id)}"
                            ng-click="selectType(t)" ng-dblclick="selectType(t, true)">
                            <span class="famfam active" ng-class="t.famfam"></span>[[ t.name ]]
                        </div>
                    </div>
                </div>
            </tab>

            <tab heading="{% trans 'Parameters' %}" active="tabs.params" disabled="!reportType">
                <h3>{% trans 'Search criteria for '%}: [[ reportType.name ]] </h3>
                <div ng-controller="paramsCtrl" class="params-form">
                    <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
                </div>
                <div class="params-form">
                    <div><label>{% trans 'Limit' %}</label> <input type="number" min="1" ng-model="reportType.limit"></div>
                    <div><label>{% trans 'Preview Limit' %}</label> <input type="number" min="1" ng-model="reportType.preview_limit"></div>
                </div>

                {% if request.user.is_superuser %}
                <div class="parms-form">
                    <div><label>{% trans 'Allow variable parameters' %}</label>
                        <input type="checkbox" ng-model="allow_var_params">
                    </div>

                    <div ng-show="allow_var_params">
                        <table>
                            <thead><tr><th colspan="2">{% trans 'Variable parameters' %}</th></tr>
                                    <tr><th>{% trans 'Name' %}</th><th>{% trans 'Value' %}</th></tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="(k, v) in var_params">
                                    <td>$[[ k ]]</td>
                                    <td><input type="text" ng-model="var_params[k]">
                                        <span title="Remove" ng-click="rmVarParam(k)" class="famfam active famfam-bullet_toggle_minus"> - </span>
                                    </td>
                                </tr>
                                <tr ng-init="new_k=''; new_v=''">
                                    <td>$<input type="text" ng-model="new_k"></td>
                                    <td><input type="text" ng-model="new_v">
                                        <span title="Add" ng-click="var_params[new_k] = new_v; new_k= ''; new_v = ''" class="famfam active famfam-bullet_toggle_plus">+</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <p class="hint">{%blocktrans %}These values are NOT stored with the report.
                            They have to be given, again, each time the report is requested.
                        {% endblocktrans %}
                        </p>
                    </div>
                </div>
                {% endif %}

                <div id="fmt-notes">
                    <h3>{% trans 'Notes' %}</h3>
                    <textarea ng-model="reportType.notes" placeholder="{%trans 'Write your notes, which will be printed in the report' %}">
                    </textarea>
                </div>
            </tab>
            <tab heading="{% trans 'Formatting' %}" active="tabs.format" disabled="!reportType">
                <h3>{% trans 'Formatting style' %}</h3>
                <!-- Vertical pos: groupping 
                    Horizontal pos: order of columns
                -->
                <div class="formatting-form" ng-controller="formattingCtrl">
                    <table id="fmt-form-table">
                        <tr><th>&nbsp;</th><th colspan="[[ fmtTable.length + 2 ]]">{% trans 'Columns...' %}</tr>
                        <tr ng-repeat="fname in reportGroups" ng-init="field=fieldByPath(fname)">
                            <th>{% trans 'Group' %} [[ $index + 1 ]] 
                                <select ng-model="field.fmt.group_mode">
                                    <option value="table">{%trans 'Table' %}</option>
                                    <option value="row">{% trans 'Row' %}</option>
                                    <option value="left_col">{%trans "Left column" %}</option>
                                </select>
                            </th>
                            <td><div ng-draggable="true" ng-drag-model="field"
                                ng-click-send="field" ng-click-align="field-fmt-palette"
                                ng-droppable="true" ng-ondrop="addToGroup(field, dragItem)"
                                jqyoui-options="{'cursorAt': {'left': 5, 'top': 5}, 'tolerance': 'pointer'}"
                                class="add-after">[[field.full_name]]
                                <span ng-if="field.fmt && field.fmt.order=='+'" class="famfam active famfam-arrow_down"></span>
                                <span ng-if="field.fmt && field.fmt.order=='-'" class="famfam active famfam-arrow_up"></span>
                                </div>
                            </td>
                            <td ng-repeat="field2 in get_fmt_fields(field)">
                                <div ng-draggable="true" ng-drag-model="field2"
                                ng-droppable="true" ng-ondrop="addToGroup(field, dragItem, field2)"
                                jqyoui-options="{'cursorAt': {'left': 5, 'top': 5}, 'tolerance': 'pointer'}"
                                ng-click-send="field2" ng-click-align="field-fmt-palette"
                                class="add-after" >[[field2.name]]
                                <span ng-if="field.fmt && field.fmt.order=='+'" class="famfam active famfam-arrow_down"></span>
                                <span ng-if="field.fmt && field.fmt.order=='-'" class="famfam active famfam-arrow_up"></span>
                                </div>
                            </td>
                        </tr>
                        <tr class="add-group"><th>{% trans 'Add group...' %}</th>
                            <td colspan="[[ fmtTable.length + 2 ]]" ng-droppable="true"
                                ng-ondrop="addGroup(dragItem)" jqyoui-options="{'tolerance': 'pointer'}">{% trans 'drag here to add group...' %}</td></tr>
                        <tr ng-class="{'no-details': !reportType.show_detail}"><th><input type="checkbox" ng-model="reportType.show_detail">{% trans 'detailed:'%}</th>
                            <td><div ng-droppable="true" ng-ondrop="addToField(dragItem)" class="add-before"></div></td>
                            <td ng-repeat="field in fmtTable|seqSort:true">
                                <div ng-draggable="true" ng-drag-model="field"
                                    ng-droppable="true" ng-ondrop="addToField(dragItem, field)"
                                    jqyoui-options="{'cursorAt': {'left': 5, 'top': 5}, 'tolerance': 'pointer'}"
                                    class="add-after">
                                    <a ng-click-send="field" ng-click-align="field-fmt-palette">[[ field.full_name ]]</a>
                                    <span ng-if="field.fmt && field.fmt.order=='+'" class="famfam active famfam-arrow_down"></span>
                                    <span ng-if="field.fmt && field.fmt.order=='-'" class="famfam active famfam-arrow_up"></span>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div id="fmt-trash" ng-droppable="true" ng-ondrop="removeField(dragItem)"
                        jqyoui-options="{'tolerance': 'pointer' }">
                        <span class="famfam active famfam-bin"></span>
                        {% trans 'Drag any field here to hide/ungroup' %}
                        <div class="fields-list">
                            <div ng-repeat="field in fmtTable|hiddenOnly"
                                ng-draggable="true" ng-drag-model="field"
                                jqyoui-options="{'cursorAt': {'left': 5, 'top': 5}}">
                                [[ field.full_name ]]
                            </div>
                        </div>
                    </div>
                </div>
                <div move-hook id="field-fmt-palette" style="min-width: 300px;"
                        move-hook-yoffset="-2"
                        under="fmt-form-table" ng-click-receive="field">
                    <div class="popover bottom" style="display: block" >
                        <div class="arrow" style="left: 20px"></div>
                        <div class="popover-inner">
                            <h3 class="popover-title">{% trans 'Field:'%} [[ field.full_name ]]
                                <a ng-click="close()" style="float:right;" title="close">&times;</a>
                            </h3>
                            <div class="popover-content">
                                <div ng-if="field.hide">{% trans 'Hidden' %}</div>
                                <div ng-show="field.fmt.hide">{% trans 'Hidden' %}
                                    <a ng-click="field.fmt.hide=false" title="{% trans 'Unhide' %}"><span class="famfam active famfam-eye"></span></a>
                                </div>
                                <div ng-show="!field.fmt.hide">
                                    {%trans 'Title:' %}
                                    <input type="text" ng-model="field.fmt.title">
                                </div>
                                {% if request.user.is_superuser %}
                                <div>Pos: <input type="number" style="width: 4em;" ng-model="field.fmt.sequence"></div>
                                <code>[[ field.full_path ]]</code>
                                <code>[[ field.fmt|json ]]</code>
                                {% endif %}
                                <div>
                                    {% trans "Order:" %}
                                    <select ng-model="field.fmt.order">
                                        <option value=""></option>
                                        <option value="+">{% trans 'Ascending' %}</option>
                                        <option value="-">{% trans 'Descending' %}</option>
                                    </select>
                                </div>
                                <div ng-if="field.fields">
                                    {% trans 'Display:' %}
                                    <select ng-model="field.fmt.display"
                                        ng-options="k as f.name for (k, f) in field.fields">
                                        <option value=""></option>
                                    </select>

                                    <div class="more-fields">
                                        {% trans 'Additional fields:' %}
                                        <div ng-repeat="field2 in field.fields"
                                            ng-draggable="true" ng-drag-model="field2"
                                            jqyoui-options="{'cursorAt': {'left': 5, 'top': 5}}">
                                            [[ field2.name ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </tab>
            <tab heading="{% trans 'Preview' %}" active="tabs.preview" disabled="!reportType">
                <h3>{% trans 'Results' %}</h3>
                <div ng-controller="previewCtrl">
                    {% if request.user.is_superuser %}
                        <div style="word-wrap: break-word">Domain:
                            [[ cur_domain ]]
                        </div>
                        <div class="var_params">
                            Var. params:
                            <dl ng-repeat="(key, val) in var_params"><dt>$[[ key]]</dt><dd>[[ val]] </dd></dl>
                        </div>
                    {% endif %}
                    <div ng-show="wait_results">{% trans 'Please wait, calculating preview...' %}</div>
                    <div ng-if="results" class="preview-results report-results">
                        <div ng-controller="previewGroupedCtl">
                            <div class="count">{% trans "Number of results:" %} [[ results[0]._count ]]</div>
                            <div ng-include="'parts/preview-results.html'">???</div>
                        </div>
                    </div>
                    <h4 ng-if="result_alert">Error [[ result_status ]] </h4>
                    <div ng-if="result_alert" ng-bind-html="result_alert">
                    </div>
                </div>
            </tab>
            <tab heading="{% trans 'Full results' %}" active="tabs.results"
                disabled="!reportType" select="prepareResultsPost()">
                <h3>{% trans 'Full results' %}</h3>
                <div ng-controller="resultCtrl">
                    <p>{% blocktrans%} You can get the results in the following formats (in a new window) {% endblocktrans %}</p>
                    <ul class="result-types">
                        <li><form id="results_form_html" class="results_form"
                                method="POST" target="_blank" action="results.html">
                            {% csrf_token %}
                            <input type="hidden" name="data" value="[[rfpost_json]]">
                            <button type="submit" ng-click="countSubmit()"><span class="famfam active famfam-html"></span>{% trans 'HTML page' %}</button>
                            </form>
                        </li>
                        <li ng-if="false"><form id="results_form_pdf" class="results_form"
                                method="POST" target="_blank" action="results.pdf">
                            {% csrf_token %}
                            <input type="hidden" name="data" value="[[rfpost_json]]">
                            <button type="submit" ng-click="countSubmit()"><span class="famfam active famfam-page_white_acrobat"></span>{% trans 'PDF document' %}</button>
                            </form>
                        </li>
                        <li ng-hide="reportGroups && reportGroups.length"><form id="results_form_csv" class="results_form"
                                method="POST" target="_blank" action="results.csv">
                            {% csrf_token %}
                            <input type="hidden" name="data" value="[[rfpost_json]]">
                            <button type="submit" ng-click="countSubmit()"><span class="famfam active famfam-page_white_database"></span>{% trans 'CSV file' %}</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </tab>
        </tabset>

    </div>
</div>

{% endblock %}

{% block web_theme_footer %}
    {{ block.super }}
<script type="text/ng-template" id="parts/field-model.html">
    <span ng-switch="field.data_op">
        <span ng-switch-when="!=" ng-dblclick="field.data_op='='">[[ field.data_op ]] </span>
        <span ng-switch-default ng-dblclick="field.data_op='!='">[[ field.data_op  || '=']] </span>
    </span>
    <dl ng-repeat="field in field.fields|seqSort">
        <dt ng-click="field.expanded = !field.expanded">
            <span class="famfam active" ng-class="{'famfam-wrench': field.expanded, 'famfam-resultset_next': !field.expanded}"></span>
            [[ field.name ]]
        </dt>
        <a ng-show="field.expanded" class="add-as-field" ng-click="addAsField(field)"
                title="{% trans 'Add condition as column to result' %}">
            <span class="famfam active famfam-table_add">+</span>
        </a>
        <dd ng-if="!field.expanded"> [[ formatParmsData(field) ]] </dd>
        <dd ng-if="field.expanded" class="expanded">
            <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
        </dd>
    </dl>
</script>

<script type="text/ng-template" id="parts/field-model-product.html">
    <div ng-controller="productParamsCtrl">
        <div ng-include="'parts/field-model.html'"></div>
    </div>
</script>

<script type="text/ng-template" id="parts/field-char.html">
    {% if request.user.is_staff or request.user.is_superuser %}
    <select ng-model="field.data_op">
        <option value="icontains"> ilike </option>
        <option value="contains"> like </option>
        <option value="="> = </option>
        <option value="!="> != </option>
        <option value="not icontains"> not like </option>
    </select>
    {% endif %}
    <input type="text" ng-model="field.data"></input>
</script>

<script type="text/ng-template" id="parts/field-id.html">
    <!-- ID not searchable -->
</script>

<script type="text/ng-template" id="parts/field-.html">
    ???
</script>

<script type="text/ng-template" id="parts/field-null.html">
</script>

<script type="text/ng-template" id="parts/field-extra_attrib.html">
    {% trans 'Read only:' %} [[ field.name ]]
</script>

<script type="text/ng-template" id="parts/field-extra_condition.html">
    extra condition [[ field.data ]]
</script>

<script type="text/ng-template" id="parts/field-isset.html">
    <select ng-model="field.data">
        <option value="">*</option>
        <option value="0">{% trans 'Empty' %}</option>
        <option value="1">{% trans 'Set' %}</option>
    </select>
</script>

<script type="text/ng-template" id="parts/field-count.html">
    <div>
        <select ng-model="field.data_op">
            <option value=">=">&gt;=</option>
            <option value="<">&lt;</option>
            <option value='='>=</option>
        </select>
        <input type="number" min="0" ng-model="field.data">
    </div>
</script>

<script type="text/ng-template" id="parts/field-attribs_count.html">
    <div ng-controller="attribsCountCtrl">
        <div ng-repeat="attr in field.attribs">
            <label ng-bind="attr.name"></label>
            <select ng-model="field.data_op[attr.aid]">
                <option value=">="> &gt;=</option>
                <option value="<">&lt;</option>
                <option value="=">=</option>
            </select>
            <input type="number" min="0.0" ng-model="field.data[attr.aid]">
        </div>
    </div>
</script>

<script type="text/ng-template" id="parts/field-boolean.html">
    <select ng-model="field.data">
        <option value="">*</option>
        <option value="true">{% trans 'True' %}</option>
        <option value="false">{% trans 'False' %}</option>
    </select>
</script>

<script type="text/ng-template" id="parts/field-has_sth.html">
    <select ng-model="field.data">
        <option value="">*</option>
        <option value="true">{% trans 'Has' %}</option>
        <option value="false">{% trans "Doesn't have" %}</option>
    </select>
</script>

<script type="text/ng-template" id="parts/field-date.html">
    <select ng-model="field.data_op" ng-change="adapt_date(field)">
        <option value=""></option>
        <option value="=">=</option>
        <option value="&gt;">&gt;</option>
        <option value="&gt;=">&gt;=</option>
        <option value="&lt;">&lt;</option>
        <option value="&lt;=">&lt;=</option>
        <option value="between">{% trans 'Between' %}</option>
    </select>
    <input type="text" ng-if="field.data_op && field.data_op != 'between'" ng-model="field.data"
            datepicker-popup="dd/MM/yyyy">
    <input type="text" ng-if="field.data_op == 'between'" ng-model="field.data[0]" datepicker-popup="dd/MM/yyyy">
    <input type="text" ng-if="field.data_op == 'between'" ng-model="field.data[1]" datepicker-popup="dd/MM/yyyy">
</script>

<script type="text/ng-template" id="parts/field-lookup.html">
  <div ng-if="field.data_op != 'in'">
    <input ng-model="field.data" type="text" autocomplete="off"
        typeahead="d as d.repr for d in getLookup(field.lookup, $viewValue)"
        typeahead-editable="false">
    <a ng-click="addFieldMulti(field)" title="{% trans 'Add value' %}" class="famfam active famfam-bullet_toggle_plus">+</a>
  </div>
  <div ng-if="field.data_op == 'in'" ng-init="di = {i: field.data.length-1}">
    <span ng-repeat="dv in field.data">
        <a ng-if="$index != di.i" ng-click="selFieldMulti(field, di, $index)">[[ dv.repr ]]</a>
        <input ng-if="$index == di.i" ng-model="field.data[$index]"
            type="text" autocomplete="off"
            typeahead="d as d.repr for d in getLookup(field.lookup, $viewValue)"
            typeahead-editable="false">
        <span ng-if="$index == di.i" ng-click="rmFieldMulti(field, $index, di)"
            title="{% trans 'Remove this value' %}" class="famfam active famfam-bullet_toggle_minus">-</span>
        <span ng-if="!$last"> {% trans 'or' %} </span>
    </span>
    <a ng-click="addFieldMulti(field, di)" class="famfam active famfam-bullet_toggle_plus" title="{% trans 'Add value' %}">+</a>
  </div>
</script>

<script type="text/ng-template" id="parts/field-selection.html">
    <select ng-model="field.data" ng-options="d[0] as d[1] for d in field.selection">
        <option value="">{% trans '(none)'%}</option>
    </select>
</script>

<script type="text/ng-template" id="parts/field-contains.html">
    <div ng-repeat="field in field.contains_data">
        {% trans 'containing:' %}
        <a ng-click="removeContains(field, $parent.field)">{% trans 'Remove' %}</a>
        <div ng-include="'parts/field-'+ field.widget +'.html'"></div>
    </div>
    <div>
        <a ng-click="addContains(field)">{% trans 'Add more...' %}</a>
    </div>
</script>

<script type="text/ng-template" id="parts/field-attribs.html">
    <div ng-repeat="attr in field.attribs">
        <label ng-bind="attr.name"></label>
        <select ng-model="field.data[attr.aid]" ng-options="d[0] as d[1] for d in attr.values">
            <option value=""></option>
        </select>
    </div>
</script>

<script type="text/ng-template" id="parts/field-attribs_multi.html">
    <div ng-repeat="attr in field.attribs">
        <div ng-controller="attribsCtrl">
            <label ng-bind="attr.name"></label>
            <a class="add-as-field" ng-click="addAttribAsField(field, attr)"
                    title="{% trans 'Add attribute as column to result' %}">
                <span class="famfam active famfam-table_add">+</span>
            </a>
            <span ng-repeat="fd in data">
                <a ng-click="setCurEdit($index)" ng-show="cur_edit!=$index">[[ visibleName(fd, attr.values) ]]</a>
                <select ng-show="cur_edit == $index" ng-model="data[$index]" ng-options="d[0] as d[1] for d in remainingValues(data, $index)">
                    <option value=""></option>
                </select>
            </span>
            + <select ng-show="cur_edit==-1" ng-model="new_item" ng-options="d[0] as d[1] for d in remainingValues(data, -1)">
                <option value=""></option>
            </select>
        </div>
    </div>
</script>

<script type="text/ng-template" id="parts/preview-results.html">
     <div ng-if="group_mode == 'row'">
        <div class="group expanded" ng-repeat="cur_group in cur_results.values|filter:rowsFilter">
            <h4><span class="arrow-img">&nbsp;</span><span ng-repeat="fc in groupped_fields[group_level-1]|seqSort">
                    <span ng-if="fc.name && fc.name != '-'">[[ fc.name ]]:</span>
                    [[ cur_group|fmtAutoField:fc ]]
                </span>
                ([[ cur_group._count ]])</h4>
            <div ng-controller="previewGroupedCtl" ng-init="hide_head=false">
                <div ng-include="'parts/preview-results.html'"><!-- recursive --></div>
            </div>
        </div>
        <div class="group collapsed">
            <!-- In preview, there may be more groups, results -->
            <h4><span class="arrow-img">&nbsp;</span>... </h4>
        </div>
    </div>
    <div ng-if="group_mode == 'table'">
        <table class="grp_results">
            <tr ng-if="!hide_head"><th ng-repeat="fc in groupped_fields[group_level-1]|seqSort">[[ fc.name ]]</th><th>{%trans 'Count' %}</th>
            </tr>
            <tr ng-repeat-start="cur_group in cur_results.values|filter:rowsFilter">
                <td ng-repeat="fc in groupped_fields[group_level-1]|seqSort">[[ cur_group|fmtAutoField:fc ]]</td>
                <td>[[ cur_group._count ]]</td>
            </tr>
            <tr ng-repeat-end ng-show="results[group_level+1]">
                <td colspan="[[ groupped_fields[group_level-1]|seqCount:1]]">
                    <div ng-controller="previewGroupedCtl" ng-init="hide_head=false">
                        <div ng-include="'parts/preview-results.html'"><!-- recursive --></div>
                    </div>
                </td>
            </tr>
            <tr><td colspan="[[ groupped_fields[group_level-1]|seqCount:1]]">...</td>
            </tr>
        </table>
    </div>
    <div ng-if="group_mode == 'left_col'">
        <table class="grp_left_col">
            <thead>
            <tr ng-if="!hide_head"><th ng-init="fc = groupped_fields[group_level-1][0]">[[ fc.name ]]</th>
                <th ng-repeat="fc in right_cols">[[ fc.display_name ]]</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="cur_group in cur_results.values|filter:rowsFilter">
                <td class="left_col">
                    <div ng-repeat="fc in groupped_fields[group_level-1]|seqSort">
                        <span ng-if="fc.name && fc.name != '-' && fc !== groupped_fields[group_level-1][0]">[[ fc.name ]]:</span>
                        [[ cur_group|fmtAutoField:fc ]]
                    </div>
                    <div class="count">([[ cur_group._count ]])</div>
                </td>
                <td class="right_part" ng-attr-colspan="[[ right_cols.length]]">
                    <div ng-controller="previewGroupedCtl" ng-init="hide_head=true">
                        <div ng-include="'parts/preview-results.html'"><!-- recursive --></div>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="left_col"> ... </td>
                <td class="right_part" ng-attr-colspan="[[ right_cols.length]]"> ... </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div ng-if="cur_results && !(cur_results.group_by)">
        <table class="detail-results">
            <tr class="head" ng-if="!hide_head">
                <th ng-repeat="fc in field_cols">[[fc.name ]]</th>
            </tr>
            <tr ng-repeat="row in cur_results.values|filter:rowsFilter">
                <td ng-repeat="fc in field_cols" ng-switch="fc.widget">
                    <ul ng-switch-when="contains">
                        <li ng-repeat="cnt in row[fc.id]">[[cnt]]</li>
                    </ul>
                    <span ng-switch-when="date">[[ row[fc.id]|date:'dd/MM/yyyy']]</span>
                    <span ng-switch-when="boolean">[[ row[fc.id]|fmtBool ]]</span>
                    <span ng-switch-when="has_sth">[[ row[fc.id]|fmtHasSth ]]</span>
                    <span ng-switch-when="id"><a ng-href="[[ row[fc.id+'.url'] ]]" target="_blank">[[ row[fc.id] ]]</a></span>
                    <span ng-switch-when="extra_condition">[[ row[fc.id.substr(1)]|fmtBool]]</span>
                    <span ng-switch-when="extra_attrib">[[ row[fc.id.substr(1)] ]]</span>
                    <span ng-switch-default ng-bind="row[fc.id]"></span>
                </td>
            </tr>
        </table>
    </div>
</script>
<script type="text/ng-template" id="parts/file-load.html">
    <div class="modal-header">
        <button style="float: right;" class="btn btn-link btn-mini" ng-click="$dismiss()">&times;</button>
        <h3>{% trans 'Load saved report' %}</h3>
    </div>
    <div class="modal-body file-load">
        <div>{% blocktrans %}Select a report to load{% endblocktrans %}</div>
        <div style="overflow: auto; margin-top: 16px; max-height: 300px">
            <div ng-repeat="r in reports">
                <span class="famfam active famfam-report"></span><a ng-click="$close(r.id)">[[ r.title ]]</a>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button ng-click="$dismiss()" class="btn btn-primary">{% trans 'Cancel' %}</button>
    </div>
</script>

<script type="text/ng-template" id="parts/file-save.html">
    <div class="modal-header">
        <button style="float: right;" class="btn btn-link btn-mini" ng-click="$dismiss()">&times;</button>
        <h3>{% trans 'Save report' %}</h3>
    </div>
    <div class="modal-body file-save">
        <div>{% trans 'Title' %}: <input ng-model="report.title" type="text"></div>
        {% if user.is_staff %}
        <div>
            <input type="checkbox" ng-model="report.public"><label>{% trans 'Public' %}</label>
        </div>
        {% endif %}
        <alert ng-show="message" ng-bind="message"></alert>
    </div>
    <div class="modal-footer">
        <button ng-show="has_btn && report.title" ng-click="do_save()" class="btn btn-success">{% trans 'Save' %}</button>
        <button ng-show="has_btn" ng-click="$dismiss()" class="btn btn-primary">{% trans 'Cancel' %}</button>
    </div>
</script>

<script type="text/ng-template" id="parts/file-delete.html">
    <div class="modal-header">
        <button style="float: right;" class="btn btn-link btn-mini" ng-click="$dismiss()">&times;</button>
        <h3>{% trans 'Delete report' %}</h3>
    </div>
    <div class="modal-body">
        <h4> [[ report.title ]]</h4>
        <div>{% blocktrans %}Do you really want to delete this report?{% endblocktrans %}</div>
        
    </div>
    <div class="modal-footer">
        <button ng-click="$close(report_id)" class="btn btn-delete">{% trans 'Delete' %}</button>
        <button ng-click="$dismiss()" class="btn btn-primary">{% trans 'Cancel' %}</button>
    </div>
</script>

<script type="text/javascript">

reportsApp
    .constant('appCSRFtoken', "{{ csrf_token }}")
    .constant('appReportTypes',  {{ available_types }})
    .constant('appWords', { 
                    'true': "{% trans 'true' %}",
                    'false': "{% trans 'false' %}",
                    'has_true': "{% trans 'has' %}",
                    'has_false': "{% trans "doesn't have" %}",
                    'count': "{% trans 'Count' %}"
        })
{% if request.user.is_staff %}
    .constant('appSuperUser', true)
{% else %}
    .constant('appSuperUser', false)
{% endif %};

</script>
{% endblock %}